<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Track your daily puzzle games, build streaks, and discover new favorites">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Game Shelf">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ®</text></svg>">
    <title>Game Shelf - Your Daily Puzzle Hub</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2940;
            --bg-hover: #2a3a5a;
            --accent-gold: #f4d35e;
            --accent-green: #4ade80;
            --accent-blue: #60a5fa;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-orange: #fb923c;
            --accent-pink: #f472b6;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #6b7280;
        }

        body.light-mode {
            --bg-primary: #f5f5f7;
            --bg-secondary: #e8e8ed;
            --bg-card: #ffffff;
            --bg-hover: #f0f0f5;
            --accent-gold: #d4a012;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a5a;
            --text-muted: #8b8b9a;
        }

        body.light-mode .game-card,
        body.light-mode .community-card,
        body.light-mode .discover-card,
        body.light-mode .review-card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.light-mode .header h1 {
            background: linear-gradient(135deg, #d4a012, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
        }

        body.light-mode .share-preview {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
            border-color: var(--accent-purple);
        }

        body.light-mode .nav-tab.active {
            background: var(--accent-gold);
            color: #fff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--bg-secondary);
            position: relative;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .menu-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        /* User Account */
        .user-account {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sign-in-btn {
            background: var(--accent-gold);
            border: none;
            color: #000;
            padding: 8px 14px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sign-in-btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .user-avatar-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
            padding: 0;
            background: var(--bg-secondary);
        }

        .user-avatar-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(244, 211, 94, 0.4);
        }

        .user-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sync-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            border: 2px solid var(--bg-primary);
        }

        .sync-indicator.syncing {
            background: var(--accent-orange);
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* User Profile Modal */
        .profile-section {
            text-align: center;
            padding: 20px 0;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            margin-bottom: 15px;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-email {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin: 15px 0;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .profile-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .sync-status.synced {
            color: var(--accent-green);
        }

        .sync-status.syncing {
            color: var(--accent-orange);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header .tagline {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-gold);
            color: #000;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Bar */
        /* Hero Stats Bar */
        .hero-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .hero-goal {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .hero-goal:hover {
            background: var(--bg-hover);
        }

        .goal-ring-small {
            flex-shrink: 0;
        }

        .hero-goal-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .hero-goal-count {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .hero-goal-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .hero-stat {
            text-align: center;
            flex-shrink: 0;
        }

        .hero-stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .hero-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .hero-log-btn {
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .hero-log-btn:hover {
            background: var(--accent-gold);
            color: #000;
        }

        /* Smart Suggestion */
        .smart-suggestion {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 12px;
            padding: 12px 15px;
            margin-top: 15px;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .suggestion-content {
            flex: 1;
            min-width: 0;
        }

        .suggestion-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .suggestion-action {
            background: var(--accent-purple);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }

        .suggestion-action:hover {
            filter: brightness(1.1);
        }

        .suggestion-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
        }

        .suggestion-dismiss:hover {
            color: var(--text-primary);
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 20px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: var(--bg-hover);
        }

        .collapsible-header .section-title {
            margin: 0;
            font-size: 0.95rem;
        }

        .collapsible-chevron {
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .collapsible-chevron.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0 15px 15px;
        }

        .calendar-inner {
            padding-top: 5px;
        }

        .calendar-nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-nav-row button {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .calendar-nav-row button:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        /* Quick Log Modal */
        .quick-log-content {
            padding: 15px 0;
        }

        .quick-log-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .quick-log-content textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0 15px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-btn {
            background: var(--bg-hover);
            border: 2px dashed var(--text-muted);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .add-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Game Grid */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }

        .game-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }

        .game-card:hover {
            background: var(--bg-hover);
            transform: translateY(-3px);
        }

        .game-card.played-today {
            border-color: var(--accent-green);
        }

        .game-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        .game-card .name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .game-card .streak {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .game-card .streak.active {
            color: var(--accent-gold);
        }

        .game-card .check-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-green);
            color: #000;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .game-card .remove-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.3);
            border: none;
            color: var(--text-muted);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .game-card:hover .remove-btn {
            opacity: 1;
        }

        .game-card .remove-btn:hover {
            background: var(--accent-red);
            color: #fff;
        }

        .game-card .rating {
            margin-top: 5px;
        }

        .game-card .rating .star {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .game-card .rating .star.filled {
            color: var(--accent-gold);
        }

        /* Featured Games (RB Games) */
        .featured-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }

        .featured-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-hover));
            border: 2px solid var(--accent-purple);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .featured-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(167, 139, 250, 0.2);
        }

        .featured-card.played-today {
            border-color: var(--accent-green);
        }

        .featured-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-purple);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* New Game Spotlight */
        .spotlight-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            border: 2px solid var(--accent-orange);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .spotlight-card .icon {
            font-size: 4rem;
        }

        .spotlight-card .info {
            flex: 1;
        }

        .spotlight-card .badge {
            background: var(--accent-orange);
            color: #000;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 8px;
        }

        .spotlight-card h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .spotlight-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .spotlight-card .btn {
            padding: 10px 20px;
        }

        /* Community Links */
        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .community-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .community-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .community-card .icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .community-card.discord .icon { background: #5865F2; }
        .community-card.reddit .icon { background: #FF4500; }
        .community-card.twitter .icon { background: #1DA1F2; }
        .community-card.facebook .icon { background: #1877F2; }
        .community-card.youtube .icon { background: #FF0000; }
        .community-card.tiktok .icon { background: #000000; }
        .community-card.threads .icon { background: #000000; }
        .community-card.bluesky .icon { background: #0085FF; }
        .community-card.mastodon .icon { background: #6364FF; }

        /* Friends & Leaderboard */
        .friends-signin-prompt {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .signin-prompt-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .friends-signin-prompt h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .friends-signin-prompt p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .leaderboard-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            gap: 12px;
            border-bottom: 1px solid var(--bg-hover);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item.current-user {
            background: rgba(255, 215, 0, 0.1);
        }

        .leaderboard-rank {
            font-weight: 800;
            font-size: 1.1rem;
            width: 30px;
            text-align: center;
            color: var(--text-muted);
        }

        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }

        .leaderboard-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .leaderboard-avatar.placeholder {
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }

        .leaderboard-score {
            font-weight: 800;
            color: var(--accent-gold);
            font-size: 1.1rem;
        }

        .leaderboard-score span {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .leaderboard-empty, .activity-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .activity-text strong {
            color: var(--accent-gold);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .activity-game-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Friends List */
        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .friend-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .friend-status.active {
            color: var(--accent-green);
        }

        .friends-count {
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .add-friend-btn {
            width: 100%;
        }

        /* Add Friend Modal */
        .friend-code-display {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .friend-code-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .friend-code {
            font-size: 1.8rem;
            font-weight: 800;
            font-family: monospace;
            color: var(--accent-gold);
            letter-spacing: 2px;
        }

        .friend-code-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-family: monospace;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .friend-code-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Extension Modal */
        .extension-browser-tabs {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .ext-tab {
            flex: 1;
            min-width: 60px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ext-tab:hover {
            background: var(--bg-hover);
        }

        .ext-tab.active {
            background: var(--accent-gold);
            color: #000;
            font-weight: 600;
        }

        .ext-instructions {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
        }

        .ext-step {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .ext-step:last-child {
            margin-bottom: 0;
        }

        .ext-step-num {
            width: 28px;
            height: 28px;
            background: var(--accent-purple);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .ext-step-content {
            flex: 1;
        }

        .ext-step-content strong {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .ext-step-content p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 4px 0 0 0;
        }

        .ext-step-content code {
            background: var(--bg-hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-gold);
        }

        .community-card .info h4 {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .community-card .info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Reviews Section */
        .review-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .review-header .icon {
            font-size: 2.5rem;
        }

        .review-header .info h4 {
            font-size: 1.1rem;
        }

        .review-header .stars {
            color: var(--accent-gold);
        }

        .review-notes {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            min-height: 60px;
        }

        .review-notes:empty::before {
            content: 'No notes yet. Click to add...';
            color: var(--text-muted);
            font-style: italic;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Discover Grid */
        .discover-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .discover-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .discover-card:hover {
            background: var(--bg-hover);
        }

        .discover-card .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .discover-card .icon {
            font-size: 2rem;
        }

        .discover-card .name {
            font-weight: 700;
        }

        .discover-card .source {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .discover-card .description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .discover-card .tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .discover-card .tag {
            background: var(--bg-secondary);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal h2 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Game List in Registration */
        .game-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .game-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .game-list-item:hover {
            background: var(--bg-hover);
        }

        .game-list-item.selected {
            background: var(--bg-hover);
            border: 2px solid var(--accent-green);
        }

        .game-list-item .icon {
            font-size: 1.5rem;
        }

        .game-list-item .info {
            flex: 1;
        }

        .game-list-item .name {
            font-weight: 600;
        }

        .game-list-item .source {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .game-list-item .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--text-muted);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: all 0.2s;
        }

        .game-list-item.selected .checkbox {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }

        /* Form Inputs */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Star Rating Input */
        .star-rating-input {
            display: flex;
            gap: 5px;
        }

        .star-rating-input .star {
            font-size: 1.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating-input .star:hover,
        .star-rating-input .star.filled {
            color: var(--accent-gold);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: #000;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-secondary);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 15px;
                padding-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header .tagline {
                font-size: 0.85rem;
            }

            .hero-stats {
                gap: 10px;
                padding: 10px;
            }

            .hero-goal-count {
                font-size: 1.2rem;
            }

            .hero-stat-value {
                font-size: 1.1rem;
            }

            .hero-log-btn {
                width: 40px;
                height: 40px;
            }

            .game-grid, .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .game-card {
                padding: 15px 10px;
            }

            .game-card .icon {
                font-size: 2rem;
            }

            .game-card .name {
                font-size: 0.85rem;
            }

            .nav-tabs {
                gap: 3px;
                padding: 4px;
            }

            .nav-tab {
                padding: 10px 8px;
                font-size: 0.75rem;
                min-width: 70px;
            }

            .section-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .section-title {
                font-size: 0.95rem;
            }

            .add-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .spotlight-card {
                flex-direction: column;
                text-align: center;
                padding: 20px 15px;
            }

            .spotlight-card .icon {
                font-size: 2.5rem;
                margin-bottom: 10px;
            }

            .community-grid {
                grid-template-columns: 1fr;
            }

            .share-preview {
                padding: 15px;
            }

            .share-stats-row {
                gap: 15px;
            }

            .share-stat-value {
                font-size: 1.4rem;
            }

            .share-games-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .share-buttons {
                flex-direction: column;
            }

            .share-buttons .btn {
                min-width: 100%;
            }

            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }

            .discover-grid {
                gap: 10px;
            }

            .discover-card {
                padding: 12px;
            }

            .discover-card .icon {
                font-size: 1.8rem;
            }

            .review-card {
                padding: 15px;
            }

            .chat-messages {
                max-height: 250px;
            }

            .featured-badge {
                font-size: 0.55rem;
                padding: 2px 5px;
            }

            /* Settings menu full width on mobile */
            .settings-menu {
                max-width: 100%;
            }

            /* Insights mobile */
            .insights-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .insight-card {
                padding: 15px;
            }

            .insight-value {
                font-size: 1.5rem;
            }

            .wrapped-section {
                padding: 20px;
            }

            .wrapped-title {
                font-size: 1.4rem;
            }

            .wrapped-stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .wrapped-stat-value {
                font-size: 1.4rem;
            }

            .daily-goal-section {
                padding: 15px;
            }

            .daily-goal-progress {
                gap: 12px;
            }

            .daily-goal-ring {
                width: 70px;
                height: 70px;
            }

            .daily-goal-count {
                font-size: 1.3rem;
            }

            .daily-goal-message {
                font-size: 1rem;
            }

            .game-ranking-list {
                font-size: 0.9rem;
            }

            .goal-options {
                grid-template-columns: repeat(2, 1fr);
            }

            /* User account mobile */
            .sign-in-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            .user-avatar-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 380px) {
            .game-grid, .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .game-card {
                padding: 12px 8px;
            }

            .game-card .icon {
                font-size: 1.8rem;
            }

            .game-card .name {
                font-size: 0.8rem;
            }

            .nav-tab {
                padding: 10px 8px;
                font-size: 0.7rem;
                min-height: 44px;
            }

            .hero-stats {
                gap: 8px;
                padding: 8px;
            }

            .goal-ring-small {
                width: 50px;
                height: 50px;
            }

            .hero-goal-count {
                font-size: 1rem;
            }

            .hero-stat-value {
                font-size: 1rem;
            }
        }

        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            .game-card {
                transition: transform 0.1s;
            }

            .game-card:active {
                transform: scale(0.98);
            }

            .nav-tab:active {
                opacity: 0.8;
            }

            .btn:active {
                transform: scale(0.98);
            }

            /* Ensure minimum touch target size */
            button, .btn, .nav-tab, .add-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .collapsible-header {
                min-height: 52px;
            }

            .calendar-nav-row button {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }

        /* RSS List */
        .rss-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rss-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rss-item:hover {
            background: var(--bg-hover);
        }

        .rss-icon {
            font-size: 1.5rem;
        }

        .rss-info {
            flex: 1;
        }

        .rss-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .rss-url {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
        }

        .copy-btn {
            background: var(--bg-hover);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .rss-item:hover .copy-btn {
            background: var(--accent-gold);
            color: #000;
        }

        /* Chat/Discussion */
        .chat-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            background: var(--bg-secondary);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-message:last-child {
            margin-bottom: 0;
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-message-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .chat-message-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message:hover .chat-message-delete {
            opacity: 1;
        }

        .chat-message-delete:hover {
            color: var(--accent-red);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-hover);
        }

        .chat-input-container input {
            flex: 1;
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .chat-input-container input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .chat-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Calendar Heatmap */
        .calendar-section {
            margin-top: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-nav button {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 4px 0;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 1;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
        }

        .calendar-day.level-0 { background: var(--bg-card); }
        .calendar-day.level-1 { background: rgba(74, 222, 128, 0.25); }
        .calendar-day.level-2 { background: rgba(74, 222, 128, 0.5); }
        .calendar-day.level-3 { background: rgba(74, 222, 128, 0.75); }
        .calendar-day.level-4 { background: var(--accent-green); color: #000; }

        .calendar-day.today {
            border: 2px solid var(--accent-gold);
        }

        .calendar-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .calendar-month-label {
            text-align: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .calendar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .calendar-day:hover .calendar-tooltip {
            opacity: 1;
        }

        /* Daily Goal */
        .daily-goal-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            border-radius: 16px;
            border: 2px solid var(--accent-gold);
        }

        .daily-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .daily-goal-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .daily-goal-edit {
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .daily-goal-edit:hover {
            color: var(--accent-gold);
        }

        .daily-goal-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .daily-goal-ring {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }

        .daily-goal-ring svg {
            transform: rotate(-90deg);
        }

        .daily-goal-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .daily-goal-ring .bg {
            stroke: var(--bg-hover);
        }

        .daily-goal-ring .progress {
            stroke: var(--accent-gold);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .daily-goal-ring .complete {
            stroke: var(--accent-green);
        }

        .daily-goal-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .daily-goal-count {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .daily-goal-target {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .daily-goal-info {
            flex: 1;
        }

        .daily-goal-message {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .daily-goal-submessage {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .daily-goal-complete {
            color: var(--accent-green);
        }

        /* Insights Tab Styles */
        .insights-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .insights-period-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .insights-period-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .insights-period-btn.active {
            background: var(--accent-gold);
            color: #000;
        }

        .insights-period-btn:hover:not(.active) {
            background: var(--bg-hover);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .insight-card.full-width {
            grid-column: span 2;
        }

        .insight-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-gold);
            line-height: 1;
            margin-bottom: 5px;
        }

        .insight-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .insight-change.positive {
            color: var(--accent-green);
        }

        .insight-change.negative {
            color: var(--accent-red);
        }

        /* Cross-Game Insights */
        .cross-insights-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .cross-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .cross-insight-item:last-child {
            margin-bottom: 0;
        }

        .cross-insight-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .cross-insight-text {
            flex: 1;
        }

        .cross-insight-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .cross-insight-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Game Rankings */
        .game-ranking-list {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .game-ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .game-ranking-item:last-child {
            border-bottom: none;
        }

        .game-ranking-position {
            width: 28px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .game-ranking-item:nth-child(1) .game-ranking-position {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #000;
        }

        .game-ranking-item:nth-child(2) .game-ranking-position {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #000;
        }

        .game-ranking-item:nth-child(3) .game-ranking-position {
            background: linear-gradient(135deg, #cd7f32, #b8722b);
            color: #000;
        }

        .game-ranking-icon {
            font-size: 1.5rem;
        }

        .game-ranking-info {
            flex: 1;
        }

        .game-ranking-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .game-ranking-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .game-ranking-streak {
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Annual Wrapped */
        .wrapped-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }

        .wrapped-year {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .wrapped-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .wrapped-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .wrapped-stat {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
        }

        .wrapped-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
        }

        .wrapped-stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .wrapped-highlight {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wrapped-highlight-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .wrapped-highlight-value {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wrapped-share-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .wrapped-share-btn:hover {
            transform: scale(1.05);
        }

        /* Deep Link Share */
        .share-link-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .share-link-input {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .share-link-input input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-hover);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
        }

        .share-link-input button {
            padding: 10px 20px;
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        /* Best Day/Time */
        .best-time-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }

        .best-time-cell {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .best-time-cell.active {
            background: var(--accent-green);
            color: #000;
        }

        .best-time-label {
            text-align: center;
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Goal Setting Modal */
        .goal-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .goal-option {
            padding: 15px 10px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-option:hover {
            border-color: var(--accent-gold);
        }

        .goal-option.selected {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: #000;
        }

        .goal-option-value {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .goal-option-label {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Achievements */
        .achievements-section {
            margin-top: 25px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .achievement-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .achievement-card.unlocked {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-card), rgba(244, 211, 94, 0.1));
        }

        .achievement-card.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .achievement-card.locked .achievement-icon {
            filter: grayscale(1);
        }

        .achievement-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .achievement-card.unlocked .achievement-desc {
            color: var(--accent-gold);
        }

        .achievements-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .achievements-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .achievements-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-purple));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .achievements-progress-text {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-gold);
            min-width: 50px;
            text-align: right;
        }

        /* Share Text Parser */
        .parse-section {
            margin-top: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .parse-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parse-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--bg-hover);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .parse-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .parse-input::placeholder {
            color: var(--text-muted);
        }

        .parse-result {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            display: none;
        }

        .parse-result.show {
            display: block;
        }

        .parse-result.success {
            border-left: 4px solid var(--accent-green);
        }

        .parse-result.error {
            border-left: 4px solid var(--accent-red);
        }

        .parse-result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .parse-result-icon {
            font-size: 1.5rem;
        }

        .parse-result-game {
            font-weight: 700;
            color: var(--text-primary);
        }

        .parse-result-score {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .parse-btn {
            margin-top: 12px;
            width: 100%;
        }

        /* Share Shelf */
        .share-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-secondary);
        }

        .share-preview {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--accent-purple);
        }

        .share-preview-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .share-preview-header h3 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .share-preview-header p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .share-stats-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .share-stat {
            text-align: center;
        }

        .share-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .share-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .share-games-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .share-game-item {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
        }

        .share-game-item .icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        .share-game-item .name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .share-game-item .streak {
            font-size: 0.65rem;
            color: var(--accent-gold);
        }

        .share-footer {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: var(--bg-card);
            z-index: 1500;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .settings-menu.active {
            transform: translateX(0);
        }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-header h2 {
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .settings-close {
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .settings-item-label .icon {
            font-size: 1.2rem;
        }

        .toggle-switch {
            width: 52px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: var(--accent-green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .settings-footer {
            padding: 20px;
            border-top: 1px solid var(--bg-secondary);
            text-align: center;
        }

        .settings-version {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .settings-copyright {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .settings-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s;
            border-bottom: 1px solid var(--bg-secondary);
        }

        .settings-link:hover {
            color: var(--accent-gold);
        }

        .settings-link .icon {
            font-size: 1.2rem;
        }

        /* Theme Preview */
        .theme-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .theme-option {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
            background: var(--bg-primary);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .theme-option.active {
            border-color: var(--accent-gold);
        }

        .theme-option:hover {
            border-color: var(--accent-gold);
        }

        .theme-option .preview {
            width: 100%;
            height: 30px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .theme-option.dark .preview {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }

        .theme-option.light .preview {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
        }

        .theme-option .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <button class="menu-btn" onclick="toggleSettingsMenu()" aria-label="Open menu">â˜°</button>
                <div>
                    <h1>ðŸŽ® Game Shelf</h1>
                    <p class="tagline">Your Daily Puzzle Hub</p>
                </div>
                <div class="user-account">
                    <button class="sign-in-btn" id="sign-in-btn" onclick="signInWithGoogle()">
                        <span>G</span> Sign In
                    </button>
                    <button class="user-avatar-btn" id="user-avatar-btn" onclick="showProfileModal()" style="display: none;">
                        <img id="user-avatar" src="" alt="Profile">
                        <div class="sync-indicator" id="sync-indicator"></div>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('games')">ðŸŽ¯ Games</button>
            <button class="nav-tab" onclick="switchTab('insights')">ðŸ“Š Insights</button>
            <button class="nav-tab" onclick="switchTab('discover')">ðŸ” Discover</button>
            <button class="nav-tab" onclick="switchTab('community')">ðŸ’¬ Community</button>
        </div>

        <!-- Games Tab -->
        <div class="tab-content active" id="tab-games">
            <!-- Compact Stats + Goal Hero -->
            <div class="hero-stats">
                <div class="hero-goal" onclick="showGoalModal()">
                    <svg width="60" height="60" class="goal-ring-small">
                        <circle class="bg" cx="30" cy="30" r="25" fill="none" stroke="var(--bg-hover)" stroke-width="6"></circle>
                        <circle class="progress" cx="30" cy="30" r="25" fill="none" stroke="var(--accent-gold)" stroke-width="6"
                            stroke-dasharray="157" stroke-dashoffset="157" stroke-linecap="round"
                            id="goal-progress-circle" style="transform: rotate(-90deg); transform-origin: center;"></circle>
                    </svg>
                    <div class="hero-goal-text">
                        <span class="hero-goal-count" id="goal-current">0</span>
                        <span class="hero-goal-label">/<span id="goal-target">5</span> goal</span>
                    </div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="best-streak">0</div>
                    <div class="hero-stat-label">ðŸ”¥ Streak</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="total-games">4</div>
                    <div class="hero-stat-label">ðŸ“š Games</div>
                </div>
                <button class="hero-log-btn" onclick="toggleQuickLog()" title="Log results">ðŸ“‹</button>
            </div>

            <!-- Smart Suggestion -->
            <div class="smart-suggestion" id="smart-suggestion" style="display: none;">
                <div class="suggestion-icon" id="suggestion-icon">ðŸ’¡</div>
                <div class="suggestion-content">
                    <div class="suggestion-text" id="suggestion-text">Try the Mini Crossword - perfect for mornings!</div>
                </div>
                <button class="suggestion-action" id="suggestion-action" onclick="actOnSuggestion()">Play</button>
                <button class="suggestion-dismiss" onclick="dismissSuggestion()">âœ•</button>
            </div>

            <!-- Featured Games (Your Games) -->
            <div class="section-header">
                <span class="section-title">â­ Featured</span>
            </div>
            <div class="featured-grid" id="featured-games"></div>

            <!-- Other Games -->
            <div class="section-header">
                <span class="section-title">ðŸ“š My Games</span>
                <button class="add-btn" onclick="showAddGameModal()">+ Add Game</button>
            </div>
            <div class="game-grid" id="my-games"></div>

            <!-- Calendar Heatmap (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('calendar')">
                    <span class="section-title">ðŸ“… Activity History</span>
                    <span class="collapsible-chevron" id="calendar-chevron">â–¶</span>
                </div>
                <div class="collapsible-content" id="calendar-content" style="display: none;">
                    <div class="calendar-inner">
                        <div class="calendar-nav-row">
                            <button onclick="prevMonth(); event.stopPropagation();">â—€</button>
                            <span class="calendar-month-label" id="calendar-month-label">January 2026</span>
                            <button onclick="nextMonth(); event.stopPropagation();">â–¶</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <div class="calendar-day-label">S</div>
                            <div class="calendar-day-label">M</div>
                            <div class="calendar-day-label">T</div>
                            <div class="calendar-day-label">W</div>
                            <div class="calendar-day-label">T</div>
                            <div class="calendar-day-label">F</div>
                            <div class="calendar-day-label">S</div>
                        </div>
                        <div class="calendar-legend">
                            <span>Less</span>
                            <div class="legend-box" style="background: var(--bg-card);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.25);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.5);"></div>
                            <div class="legend-box" style="background: rgba(74, 222, 128, 0.75);"></div>
                            <div class="legend-box" style="background: var(--accent-green);"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('achievements')">
                    <span class="section-title">ðŸ† Achievements</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="achievements-progress-text" id="achievements-progress-text">0/14</span>
                        <span class="collapsible-chevron" id="achievements-chevron">â–¼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="achievements-content" style="display: none;">
                    <div class="achievements-progress">
                        <div class="achievements-progress-bar">
                            <div class="achievements-progress-fill" id="achievements-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="achievements-grid" id="achievements-grid"></div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">Copied!</div>

        <!-- Insights Tab -->
        <div class="tab-content" id="tab-insights">
            <!-- Period Toggle -->
            <div class="insights-period-toggle">
                <button class="insights-period-btn active" onclick="setInsightsPeriod('week')">This Week</button>
                <button class="insights-period-btn" onclick="setInsightsPeriod('month')">This Month</button>
                <button class="insights-period-btn" onclick="setInsightsPeriod('year')">This Year</button>
            </div>

            <!-- Stats Grid -->
            <div class="insights-grid" id="insights-stats-grid">
                <div class="insight-card">
                    <div class="insight-icon">ðŸŽ®</div>
                    <div class="insight-value" id="insight-games-played">0</div>
                    <div class="insight-label">Games Played</div>
                    <div class="insight-change positive" id="insight-games-change">â€”</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">ðŸ“ˆ</div>
                    <div class="insight-value" id="insight-completion">0%</div>
                    <div class="insight-label">Completion Rate</div>
                    <div class="insight-change" id="insight-completion-change">â€”</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">ðŸ”¥</div>
                    <div class="insight-value" id="insight-current-streak">0</div>
                    <div class="insight-label">Current Streak</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">â­</div>
                    <div class="insight-value" id="insight-best-streak">0</div>
                    <div class="insight-label">Best Streak</div>
                </div>
            </div>

            <!-- Best Day to Play -->
            <div class="insight-card full-width" style="margin-bottom: 25px;">
                <div class="section-header" style="margin: 0 0 10px 0;">
                    <span class="section-title">ðŸ“… Best Days</span>
                </div>
                <div class="best-time-grid" id="best-days-grid"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span class="best-time-label">S</span>
                    <span class="best-time-label">M</span>
                    <span class="best-time-label">T</span>
                    <span class="best-time-label">W</span>
                    <span class="best-time-label">T</span>
                    <span class="best-time-label">F</span>
                    <span class="best-time-label">S</span>
                </div>
            </div>

            <!-- Game Rankings -->
            <div class="section-header">
                <span class="section-title">ðŸ† Most Played</span>
            </div>
            <div class="game-ranking-list" id="game-rankings"></div>

            <!-- Cross-Game Insights -->
            <div class="cross-insights-section" style="margin-top: 25px;">
                <div class="section-header" style="margin: 0 0 15px 0;">
                    <span class="section-title">ðŸ’¡ Insights</span>
                </div>
                <div id="cross-insights-list"></div>
            </div>

            <!-- Annual Wrapped Preview -->
            <div class="wrapped-section" id="wrapped-section">
                <div class="wrapped-year">2025</div>
                <div class="wrapped-title">ðŸŽ® Your Year in Games</div>
                <div class="wrapped-stats-grid">
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-total-games">0</div>
                        <div class="wrapped-stat-label">Games Played</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-total-days">0</div>
                        <div class="wrapped-stat-label">Days Active</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-best-streak">0</div>
                        <div class="wrapped-stat-label">Best Streak</div>
                    </div>
                    <div class="wrapped-stat">
                        <div class="wrapped-stat-value" id="wrapped-unique-games">0</div>
                        <div class="wrapped-stat-label">Unique Games</div>
                    </div>
                </div>
                <div class="wrapped-highlight">
                    <div class="wrapped-highlight-label">Your #1 Game</div>
                    <div class="wrapped-highlight-value" id="wrapped-top-game">
                        <span>ðŸŽ®</span> <span>â€”</span>
                    </div>
                </div>
                <button class="wrapped-share-btn" onclick="shareWrapped()">ðŸ“¤ Share Your Wrapped</button>
            </div>

            <!-- Share Your Shelf Link -->
            <div class="share-link-section">
                <div class="section-header" style="margin: 0;">
                    <span class="section-title">ðŸ”— Share Your Shelf</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                    Share a read-only view of your game shelf with friends
                </p>
                <div class="share-link-input">
                    <input type="text" id="share-link-url" value="gameshelf.app/u/your-shelf" readonly>
                    <button onclick="copyShareLink()">Copy</button>
                </div>
            </div>
        </div>

        <!-- Discover Tab -->
        <div class="tab-content" id="tab-discover">
            <!-- Spotlight -->
            <div class="spotlight-card" id="spotlight-game">
                <span class="icon">ðŸ†•</span>
                <div class="info">
                    <span class="badge">ðŸ”¥ New This Week</span>
                    <h3>Connections</h3>
                    <p>Group 16 words into 4 categories. A viral hit from the NY Times puzzle team!</p>
                    <button class="btn btn-primary btn-small" onclick="addGameFromDiscover('connections')">+ Add to Shelf</button>
                </div>
            </div>

            <div class="section-header">
                <span class="section-title">ðŸ” Discover New Games</span>
            </div>
            <div class="discover-grid" id="discover-list"></div>
        </div>

        <!-- Reviews Tab -->
        <div class="tab-content" id="tab-reviews">
            <div class="section-header">
                <span class="section-title">â­ My Reviews & Notes</span>
            </div>
            <div id="reviews-list"></div>
            <div class="empty-state" id="reviews-empty" style="display:none;">
                <div class="icon">ðŸ“</div>
                <p>No reviews yet.<br>Add games to your shelf and rate them!</p>
            </div>
        </div>

        <!-- Community Tab -->
        <div class="tab-content" id="tab-community">
            <!-- Sign-in prompt for non-authenticated users -->
            <div class="friends-signin-prompt" id="friends-signin-prompt">
                <div class="signin-prompt-icon">ðŸ‘¥</div>
                <h3>Connect with Friends</h3>
                <p>Sign in to see friends' activity, compete on leaderboards, and share your progress!</p>
                <button class="btn btn-primary" onclick="signInWithGoogle()">
                    <span>G</span> Sign In with Google
                </button>
            </div>

            <!-- Friends content (shown when signed in) -->
            <div class="friends-content" id="friends-content" style="display: none;">
                <!-- Daily Leaderboard -->
                <div class="section-header">
                    <span class="section-title">ðŸ† Today's Leaderboard</span>
                </div>
                <div class="leaderboard-card" id="daily-leaderboard">
                    <div class="leaderboard-empty">
                        <p>Add friends to see the leaderboard!</p>
                    </div>
                </div>

                <!-- Activity Feed -->
                <div class="section-header" style="margin-top: 25px;">
                    <span class="section-title">ðŸ“£ Activity Feed</span>
                </div>
                <div class="activity-feed" id="activity-feed">
                    <div class="activity-empty">
                        <p>No recent activity from friends</p>
                    </div>
                </div>

                <!-- Friends List -->
                <div class="collapsible-section" style="margin-top: 25px;">
                    <div class="collapsible-header" onclick="toggleSection('friends-list')">
                        <span class="section-title">ðŸ‘¥ Friends</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="friends-count" id="friends-count">0</span>
                            <span class="collapsible-chevron" id="friends-list-chevron">â–¶</span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="friends-list-content" style="display: none;">
                        <div class="friends-list" id="friends-list"></div>
                        <button class="btn btn-secondary add-friend-btn" onclick="showAddFriendModal()">
                            + Add Friend
                        </button>
                    </div>
                </div>
            </div>

            <!-- Community Links (Collapsible) -->
            <div class="collapsible-section" style="margin-top: 25px;">
                <div class="collapsible-header" onclick="toggleSection('community-links')">
                    <span class="section-title">ðŸŒ Community Links</span>
                    <span class="collapsible-chevron" id="community-links-chevron">â–¶</span>
                </div>
                <div class="collapsible-content" id="community-links-content" style="display: none;">
                    <div class="community-grid">
                        <a href="https://discord.gg/wordgames" target="_blank" class="community-card discord">
                            <div class="icon">ðŸ’¬</div>
                            <div class="info">
                                <h4>Discord</h4>
                                <p>Word game chat</p>
                            </div>
                        </a>
                        <a href="https://reddit.com/r/wordle" target="_blank" class="community-card reddit">
                            <div class="icon">ðŸ”´</div>
                            <div class="info">
                                <h4>r/wordle</h4>
                                <p>Daily discussions</p>
                            </div>
                        </a>
                        <a href="https://reddit.com/r/NYTGames" target="_blank" class="community-card reddit">
                            <div class="icon">ðŸ”´</div>
                            <div class="info">
                                <h4>r/NYTGames</h4>
                                <p>All NYT puzzles</p>
                            </div>
                        </a>
                        <a href="https://twitter.com/search?q=wordle" target="_blank" class="community-card twitter">
                            <div class="icon">ðŸ¦</div>
                            <div class="info">
                                <h4>Twitter/X</h4>
                                <p>Share results</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            v1.12.0 â€¢ Game Shelf
        </footer>
    </div>

    <!-- Welcome/Registration Modal -->
    <div class="modal-overlay" id="welcome-modal">
        <div class="modal">
            <h2>ðŸ‘‹ Welcome to Game Shelf!</h2>
            <p>Select the daily games you play. We'll help you track your progress and streaks!</p>
            
            <div class="game-list" id="registration-list"></div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="completeRegistration()" style="flex:1">Get Started</button>
                <button class="btn btn-secondary" onclick="skipRegistration()">Skip</button>
            </div>
        </div>
    </div>

    <!-- Add Game Modal -->
    <div class="modal-overlay" id="add-game-modal">
        <div class="modal">
            <h2>âž• Add a Game</h2>
            <p>Choose from popular games or add a custom one.</p>
            
            <div class="game-list" id="add-game-list"></div>
            
            <div style="text-align: center; margin: 20px 0; color: var(--text-muted);">â€” or add custom â€”</div>
            
            <div class="form-group">
                <label>Game URL</label>
                <input type="text" id="custom-url" placeholder="https://..." oninput="autoDetectGameInfo()">
                <small style="color: var(--text-muted); font-size: 0.75rem;">Paste URL to auto-detect game info</small>
            </div>
            <div class="form-group">
                <label>Game Name</label>
                <input type="text" id="custom-name" placeholder="e.g., Wordle">
            </div>
            <div class="form-group">
                <label>Icon (emoji)</label>
                <input type="text" id="custom-icon" placeholder="ðŸŽ®" maxlength="2">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addSelectedGames()" style="flex:1">Add Games</button>
                <button class="btn btn-secondary" onclick="closeAddGameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="review-modal">
        <div class="modal">
            <h2>â­ Rate & Review</h2>
            <div id="review-game-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <span id="review-game-icon" style="font-size: 2.5rem;"></span>
                <div>
                    <h3 id="review-game-name" style="margin: 0;"></h3>
                </div>
            </div>
            
            <div class="form-group">
                <label>Your Rating</label>
                <div class="star-rating-input" id="rating-input">
                    <span class="star" data-value="1">â˜…</span>
                    <span class="star" data-value="2">â˜…</span>
                    <span class="star" data-value="3">â˜…</span>
                    <span class="star" data-value="4">â˜…</span>
                    <span class="star" data-value="5">â˜…</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="review-notes" placeholder="Your thoughts on this game..."></textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveReview()" style="flex:1">Save Review</button>
                <button class="btn btn-secondary" onclick="closeReviewModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <!-- Settings Menu (slide-out) -->
    <div class="settings-overlay" id="settings-overlay" onclick="toggleSettingsMenu()"></div>
    <div class="settings-menu" id="settings-menu">
        <div class="settings-header">
            <h2>â˜° Menu</h2>
            <button class="settings-close" onclick="toggleSettingsMenu()">âœ•</button>
        </div>
        <div class="settings-body">
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                <div class="theme-options">
                    <div class="theme-option dark active" onclick="setTheme('dark')" id="theme-dark">
                        <div class="preview"></div>
                        <div class="label">ðŸŒ™ Dark</div>
                    </div>
                    <div class="theme-option light" onclick="setTheme('light')" id="theme-light">
                        <div class="preview"></div>
                        <div class="label">â˜€ï¸ Light</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Data</div>
                <a href="#" class="settings-link" onclick="exportData(); return false;">
                    <span class="icon">ðŸ“¤</span>
                    Export Data
                </a>
                <a href="#" class="settings-link" onclick="showWelcome(); toggleSettingsMenu(); return false;">
                    <span class="icon">ðŸ”„</span>
                    Re-run Setup
                </a>
                <a href="#" class="settings-link" onclick="resetAllData(); return false;" style="color: var(--accent-red);">
                    <span class="icon">ðŸ—‘ï¸</span>
                    Reset All Data
                </a>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Browser Extension</div>
                <a href="#" class="settings-link" onclick="showExtensionModal(); return false;">
                    <span class="icon">ðŸ§©</span>
                    Install Auto-Logger
                    <span style="background: var(--accent-green); color: #000; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">NEW</span>
                </a>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 8px 0 0 28px;">
                    Auto-log games from NYT, Worldle & more
                </p>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">About</div>
                <a href="#" class="settings-link" onclick="showAbout(); return false;">
                    <span class="icon">â„¹ï¸</span>
                    About Game Shelf
                </a>
                <a href="https://github.com/stewartdavidp-ship-it" target="_blank" class="settings-link">
                    <span class="icon">ðŸ’»</span>
                    View on GitHub
                </a>
            </div>
        </div>
        <div class="settings-footer">
            <div class="settings-version">Game Shelf v1.12.0</div>
            <div class="settings-copyright">Â© 2025 RB Games</div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <h2>ðŸŽ® About Game Shelf</h2>
            <p style="color: var(--text-secondary); margin: 15px 0; line-height: 1.6;">
                Game Shelf is your personal daily puzzle hub. Track your games, build streaks, discover new puzzles, and share your progress with friends.
            </p>
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: var(--text-muted);">Version</span>
                    <span style="color: var(--text-primary); font-weight: 600;">1.12.0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: var(--text-muted);">Released</span>
                    <span style="color: var(--text-primary); font-weight: 600;">January 2026</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Developer</span>
                    <span style="color: var(--text-primary); font-weight: 600;">RB Games</span>
                </div>
            </div>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 15px 0;">
                <strong>Featured Games:</strong> Rungs, Slate, Quotle, Word Boxing
            </p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="closeAboutModal()" style="flex:1">Close</button>
            </div>
        </div>
    </div>

    <!-- Extension Modal -->
    <div class="modal-overlay" id="extension-modal">
        <div class="modal" style="max-width: 500px;">
            <h2>ðŸ§© Browser Extension</h2>
            <p style="color: var(--text-secondary); margin: 15px 0;">
                Auto-log your daily puzzles! The extension detects when you complete a game and logs it automatically.
            </p>
            
            <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 15px 0;">
                <span style="font-size: 1.5rem;" title="Wordle">ðŸŸ©</span>
                <span style="font-size: 1.5rem;" title="Connections">ðŸ”—</span>
                <span style="font-size: 1.5rem;" title="Strands">ðŸ§µ</span>
                <span style="font-size: 1.5rem;" title="Spelling Bee">ðŸ</span>
                <span style="font-size: 1.5rem;" title="Mini">ðŸ“</span>
                <span style="font-size: 1.5rem;" title="Worldle">ðŸŒ</span>
                <span style="font-size: 1.5rem;" title="Quordle">4ï¸âƒ£</span>
                <span style="font-size: 1.5rem;" title="Octordle">8ï¸âƒ£</span>
            </div>
            
            <!-- Browser Tabs -->
            <div class="extension-browser-tabs">
                <button class="ext-tab active" onclick="showBrowserInstructions('chrome')">Chrome</button>
                <button class="ext-tab" onclick="showBrowserInstructions('edge')">Edge</button>
                <button class="ext-tab" onclick="showBrowserInstructions('brave')">Brave</button>
                <button class="ext-tab" onclick="showBrowserInstructions('firefox')">Firefox</button>
                <button class="ext-tab" onclick="showBrowserInstructions('safari')">Safari</button>
            </div>
            
            <!-- Chrome Instructions -->
            <div class="ext-instructions" id="ext-chrome">
                <div class="ext-note" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <strong>ðŸš€ Easy Install (Recommended)</strong>
                    <p style="margin: 5px 0 10px 0; font-size: 0.85rem;">Download the installer for one-click setup!</p>
                    <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                       class="btn btn-primary btn-small" download>
                        ðŸ“¥ Download Installer (Mac)
                    </a>
                    <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                       class="btn btn-secondary btn-small" style="margin-left: 8px;" download>
                        ðŸ“¥ Windows
                    </a>
                </div>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 10px;">Or manual install:</p>
                <div class="ext-step">
                    <div class="ext-step-num">1</div>
                    <div class="ext-step-content">
                        <strong>Download & unzip</strong>
                        <p>Extract gameshelf-extension.zip</p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Open <code>chrome://extensions</code></strong>
                        <p>Enable "Developer mode" (top right)</p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">3</div>
                    <div class="ext-step-content">
                        <strong>Load unpacked</strong>
                        <p>Select the unzipped folder â†’ Pin extension ðŸ“Œ</p>
                    </div>
                </div>
            </div>
            
            <!-- Edge Instructions -->
            <div class="ext-instructions" id="ext-edge" style="display: none;">
                <div class="ext-note" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <strong>ðŸš€ Same as Chrome!</strong>
                    <p style="margin: 5px 0 0; font-size: 0.85rem;">Edge uses the same extension format.</p>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">1</div>
                    <div class="ext-step-content">
                        <strong>Download & unzip</strong>
                        <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                           class="btn btn-secondary btn-small" style="margin-top: 8px;" download>ðŸ“¥ Download</a>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Open <code>edge://extensions</code></strong>
                        <p>Enable "Developer mode" (<strong>bottom left</strong>)</p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">3</div>
                    <div class="ext-step-content">
                        <strong>Load unpacked â†’ Select folder</strong>
                    </div>
                </div>
            </div>
            
            <!-- Brave Instructions -->
            <div class="ext-instructions" id="ext-brave" style="display: none;">
                <div class="ext-note" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <strong>ðŸš€ Same as Chrome!</strong>
                    <p style="margin: 5px 0 0; font-size: 0.85rem;">Brave uses the same extension format.</p>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">1</div>
                    <div class="ext-step-content">
                        <strong>Download & unzip</strong>
                        <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                           class="btn btn-secondary btn-small" style="margin-top: 8px;" download>ðŸ“¥ Download</a>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Open <code>brave://extensions</code></strong>
                        <p>Enable "Developer mode" (top right)</p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">3</div>
                    <div class="ext-step-content">
                        <strong>Load unpacked â†’ Select folder</strong>
                    </div>
                </div>
            </div>
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Open Extensions Page</strong>
                        <p>Navigate to <code>brave://extensions/</code></p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">3</div>
                    <div class="ext-step-content">
                        <strong>Enable Developer Mode</strong>
                        <p>Toggle "Developer mode" in the <strong>top right</strong></p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">4</div>
                    <div class="ext-step-content">
                        <strong>Load Extension</strong>
                        <p>Click "Load unpacked" and select the unzipped folder</p>
                    </div>
                </div>
            </div>
            
            <!-- Firefox Instructions -->
            <div class="ext-instructions" id="ext-firefox" style="display: none;">
                <div class="ext-note" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <strong>âš ï¸ Firefox Requires Conversion</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.85rem;">Firefox uses a different extension format. Temporary loading available for testing.</p>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">1</div>
                    <div class="ext-step-content">
                        <strong>Download & Unzip Extension</strong>
                        <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                           class="btn btn-secondary btn-small" style="margin-top: 8px;" download>
                            ðŸ“¥ Download ZIP
                        </a>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Open Debug Page</strong>
                        <p>Navigate to <code>about:debugging#/runtime/this-firefox</code></p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">3</div>
                    <div class="ext-step-content">
                        <strong>Load Temporary Add-on</strong>
                        <p>Click "Load Temporary Add-on" â†’ Select <code>manifest.json</code></p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">âš¡</div>
                    <div class="ext-step-content">
                        <strong>Note</strong>
                        <p>Extension will be removed when Firefox closes. Use Chrome/Edge/Brave for permanent install.</p>
                    </div>
                </div>
            </div>
            
            <!-- Safari Instructions -->
            <div class="ext-instructions" id="ext-safari" style="display: none;">
                <div class="ext-note" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <strong>ðŸš€ One-Click Install (Requires Xcode)</strong>
                    <p style="margin: 5px 0 10px 0; font-size: 0.85rem;">Download the installer - it handles everything automatically!</p>
                    <a href="https://github.com/stewartdavidp-ship-it/GameShelf/raw/main/gameshelf-extension.zip" 
                       class="btn btn-primary btn-small" download>
                        ðŸ“¥ Download Safari Installer
                    </a>
                </div>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 10px;">After downloading:</p>
                <div class="ext-step">
                    <div class="ext-step-num">1</div>
                    <div class="ext-step-content">
                        <strong>Unzip & double-click <code>install-safari.command</code></strong>
                        <p>The script builds and installs automatically</p>
                    </div>
                </div>
                <div class="ext-step">
                    <div class="ext-step-num">2</div>
                    <div class="ext-step-content">
                        <strong>Check the box in Safari Settings</strong>
                        <p>Settings opens automatically - just enable Game Shelf!</p>
                    </div>
                </div>
                <div class="ext-note" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <strong>ðŸ“‹ Prerequisite</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.85rem;">Install Xcode from the App Store first (free, ~12GB)</p>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeExtensionModal()" style="flex:1">Done</button>
            </div>
        </div>
    </div>

    <!-- Goal Setting Modal -->
    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <h2>ðŸŽ¯ Set Daily Goal</h2>
            <p style="color: var(--text-secondary); margin: 15px 0;">
                How many games do you want to play each day?
            </p>
            <div class="goal-options" id="goal-options">
                <div class="goal-option" onclick="selectGoal(3)" data-goal="3">
                    <div class="goal-option-value">3</div>
                    <div class="goal-option-label">Casual</div>
                </div>
                <div class="goal-option selected" onclick="selectGoal(5)" data-goal="5">
                    <div class="goal-option-value">5</div>
                    <div class="goal-option-label">Regular</div>
                </div>
                <div class="goal-option" onclick="selectGoal(8)" data-goal="8">
                    <div class="goal-option-value">8</div>
                    <div class="goal-option-label">Active</div>
                </div>
                <div class="goal-option" onclick="selectGoal(10)" data-goal="10">
                    <div class="goal-option-value">10+</div>
                    <div class="goal-option-label">Pro</div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label style="color: var(--text-muted); font-size: 0.85rem;">Or set a custom goal:</label>
                <input type="number" id="custom-goal" placeholder="Enter number" min="1" max="20" 
                    style="margin-top: 8px; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--bg-hover); border-radius: 8px; color: var(--text-primary); width: 100%;">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveGoal()" style="flex:1">Save Goal</button>
                <button class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Quick Log Modal -->
    <div class="modal-overlay" id="quick-log-modal">
        <div class="modal">
            <h2>ðŸ“‹ Log Game Results</h2>
            <p style="color: var(--text-secondary); margin: 10px 0;">Paste your share text from any supported game</p>
            <div class="quick-log-content">
                <textarea id="parse-input" placeholder="Paste your game results here...

Examples:
Wordle 1,234 4/6
ðŸŸ¨â¬›â¬›â¬›â¬›
ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©

Connections Puzzle #123
ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©"></textarea>
                <div class="parse-result" id="parse-result" style="display: none; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="parse-result-icon" style="font-size: 1.5rem;">ðŸŸ©</span>
                        <div>
                            <div id="parse-result-game" style="font-weight: 700;">Wordle</div>
                            <div id="parse-result-score" style="font-size: 0.85rem; color: var(--text-secondary);">4/6</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="parseShareText()" style="flex:1">âœ¨ Log Result</button>
                <button class="btn btn-secondary" onclick="closeQuickLogModal()">Cancel</button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 15px;">
                ðŸ’¡ Tip: Install Game Shelf as an app to share directly from games!
            </p>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <h2>ðŸ‘¤ Your Profile</h2>
            <div class="profile-section">
                <img id="profile-avatar" class="profile-avatar" src="" alt="Profile">
                <div class="profile-name" id="profile-name">Player</div>
                <div class="profile-email" id="profile-email">email@example.com</div>
                
                <div class="sync-status" id="sync-status">
                    <span>â˜ï¸</span> <span id="sync-status-text">Synced to cloud</span>
                </div>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-games-played">0</div>
                        <div class="profile-stat-label">Games Played</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-best-streak">0</div>
                        <div class="profile-stat-label">Best Streak</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-achievements">0</div>
                        <div class="profile-stat-label">Achievements</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-secondary" onclick="syncNow()" style="width: 100%;">ðŸ”„ Sync Now</button>
                <button class="btn btn-secondary" onclick="signOut()" style="width: 100%; color: var(--accent-red);">ðŸšª Sign Out</button>
                <button class="btn btn-primary" onclick="closeProfileModal()" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIG ============
        // Same project as Word Boxing - shared authentication
        const firebaseConfig = {
            apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
            authDomain: "word-boxing.firebaseapp.com",
            databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
            projectId: "word-boxing",
            storageBucket: "word-boxing.firebasestorage.app",
            messagingSenderId: "300155036194",
            appId: "1:300155036194:web:b35463e6f9fbb04d7fe07b"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let isFirebaseReady = false;
        let currentUser = null;
        let syncStatus = 'offline'; // offline, syncing, synced

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            isFirebaseReady = true;
            console.log('ðŸ”¥ Firebase initialized for Game Shelf');
        } catch (e) {
            console.warn('Firebase not available, using local storage only');
            isFirebaseReady = false;
        }

        // ============ DATA ============
        const FEATURED_GAMES = [
            { id: 'rungs', name: 'Rungs', icon: 'ðŸªœ', url: 'https://stewartdavidp-ship-it.github.io/Rungstest/', featured: true, description: 'Pair words and arrange in order' },
            { id: 'slate', name: 'Slate', icon: 'ðŸª¨', url: 'https://stewartdavidp-ship-it.github.io/Slate/', featured: true, description: 'Fill in consonants to reveal words' },
            { id: 'quotle', name: 'Quotle', icon: 'ðŸ’¬', url: 'https://stewartdavidp-ship-it.github.io/Quotle/', featured: true, description: 'Guess the famous quote' },
            { id: 'wordboxing', name: 'Word Boxing', icon: 'ðŸ¥Š', url: 'https://stewartdavidp-ship-it.github.io/WordBoxing/', featured: true, description: 'Multiplayer word battle' }
        ];

        const POPULAR_GAMES = [
            { id: 'wordle', name: 'Wordle', icon: 'ðŸŸ©', url: 'https://www.nytimes.com/games/wordle/index.html', source: 'NY Times', description: 'Guess the 5-letter word in 6 tries', tags: ['word', 'daily'] },
            { id: 'connections', name: 'Connections', icon: 'ðŸ”—', url: 'https://www.nytimes.com/games/connections', source: 'NY Times', description: 'Group 16 words into 4 categories', tags: ['word', 'categories'] },
            { id: 'strands', name: 'Strands', icon: 'ðŸ§µ', url: 'https://www.nytimes.com/games/strands', source: 'NY Times', description: 'Find themed words in a letter grid', tags: ['word', 'search'] },
            { id: 'spelling-bee', name: 'Spelling Bee', icon: 'ðŸ', url: 'https://www.nytimes.com/puzzles/spelling-bee', source: 'NY Times', description: 'Make words using 7 letters', tags: ['word', 'vocabulary'] },
            { id: 'mini', name: 'Mini Crossword', icon: 'ðŸ“', url: 'https://www.nytimes.com/crosswords/game/mini', source: 'NY Times', description: 'Quick daily crossword', tags: ['crossword', 'quick'] },
            { id: 'letterboxed', name: 'Letterboxed', icon: 'ðŸ“¦', url: 'https://www.nytimes.com/puzzles/letter-boxed', source: 'NY Times', description: 'Connect letters on a box', tags: ['word', 'puzzle'] },
            { id: 'tiles', name: 'Tiles', icon: 'ðŸ€„', url: 'https://www.nytimes.com/puzzles/tiles', source: 'NY Times', description: 'Match tiles to clear the board', tags: ['matching', 'visual'] },
            { id: 'vertex', name: 'Vertex', icon: 'ðŸ“', url: 'https://www.nytimes.com/puzzles/vertex', source: 'NY Times', description: 'Connect dots without crossing', tags: ['logic', 'visual'] },
            { id: 'immaculate-grid', name: 'Immaculate Grid', icon: 'âš¾', url: 'https://www.immaculategrid.com/', source: 'Sports', description: 'Baseball trivia grid', tags: ['sports', 'trivia'] },
            { id: 'costcodle', name: 'Costcodle', icon: 'ðŸ›’', url: 'https://costcodle.com/', source: 'Fun', description: 'Guess Costco product prices', tags: ['fun', 'guessing'] },
            { id: 'tradle', name: 'Tradle', icon: 'ðŸš¢', url: 'https://oec.world/en/tradle/', source: 'Geography', description: 'Guess country by exports', tags: ['geography', 'economics'] },
            { id: 'worldle', name: 'Worldle', icon: 'ðŸŒ', url: 'https://worldle.teuteuf.fr/', source: 'Geography', description: 'Guess country by outline', tags: ['geography'] },
            { id: 'globle', name: 'Globle', icon: 'ðŸŒŽ', url: 'https://globle-game.com/', source: 'Geography', description: 'Find the mystery country', tags: ['geography'] },
            { id: 'foodguessr', name: 'FoodGuessr', icon: 'ðŸ”', url: 'https://www.foodguessr.com/', source: 'Fun', description: 'Guess food origins', tags: ['food', 'geography'] },
            { id: 'quordle', name: 'Quordle', icon: '4ï¸âƒ£', url: 'https://www.merriam-webster.com/games/quordle/', source: 'Words', description: 'Solve 4 Wordles at once', tags: ['word', 'challenge'] },
            { id: 'octordle', name: 'Octordle', icon: '8ï¸âƒ£', url: 'https://octordle.com/', source: 'Words', description: 'Solve 8 Wordles at once', tags: ['word', 'challenge'] },
            { id: 'semantle', name: 'Semantle', icon: 'ðŸ§ ', url: 'https://semantle.com/', source: 'Words', description: 'Guess by word meaning similarity', tags: ['word', 'AI'] },
            { id: 'redactle', name: 'Redactle', icon: 'â–ˆ', url: 'https://redactle.net/', source: 'Knowledge', description: 'Guess the Wikipedia article', tags: ['trivia', 'deduction'] },
        ];

        // ============ STATE ============
        let userData = {
            registered: false,
            games: [],
            stats: {},
            reviews: {},
            chatMessages: [],
            history: {}, // { 'YYYY-MM-DD': { gamesPlayed: 3, totalGames: 8 } }
            achievements: {}, // { achievementId: unlockedDate }
            dailyGoal: 5 // default daily goal
        };

        let currentReviewGameId = null;
        let currentRating = 0;
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let insightsPeriod = 'week'; // week, month, year

        // Achievements definitions
        const ACHIEVEMENTS = [
            { id: 'first-game', name: 'First Steps', icon: 'ðŸ‘¶', desc: 'Play your first game', check: (d) => d.stats.totalCompleted >= 1 },
            { id: 'streak-3', name: 'Hat Trick', icon: 'ðŸŽ©', desc: '3-day streak', check: (d) => getMaxStreak(d) >= 3 },
            { id: 'streak-7', name: 'Week Warrior', icon: 'âš”ï¸', desc: '7-day streak', check: (d) => getMaxStreak(d) >= 7 },
            { id: 'streak-30', name: 'Monthly Master', icon: 'ðŸ‘‘', desc: '30-day streak', check: (d) => getMaxStreak(d) >= 30 },
            { id: 'games-5', name: 'Collector', icon: 'ðŸ“š', desc: 'Add 5 games to shelf', check: (d) => (FEATURED_GAMES.length + d.games.length) >= 5 },
            { id: 'games-10', name: 'Enthusiast', icon: 'ðŸŽ®', desc: 'Add 10 games to shelf', check: (d) => (FEATURED_GAMES.length + d.games.length) >= 10 },
            { id: 'perfect-day', name: 'Perfect Day', icon: 'ðŸ’¯', desc: 'Play all games in one day', check: (d) => hasPerfectDay(d) },
            { id: 'early-bird', name: 'Early Bird', icon: 'ðŸ¦', desc: 'Play before 7 AM', check: (d) => d.achievements?.['early-bird'] },
            { id: 'night-owl', name: 'Night Owl', icon: 'ðŸ¦‰', desc: 'Play after 11 PM', check: (d) => d.achievements?.['night-owl'] },
            { id: 'reviewer', name: 'Critic', icon: 'â­', desc: 'Write 3 reviews', check: (d) => Object.keys(d.reviews || {}).length >= 3 },
            { id: 'social', name: 'Social Butterfly', icon: 'ðŸ¦‹', desc: 'Share your shelf', check: (d) => d.achievements?.['social'] },
            { id: 'centurion', name: 'Centurion', icon: 'ðŸ›ï¸', desc: 'Complete 100 games total', check: (d) => d.stats.totalCompleted >= 100 },
            { id: 'goal-streak-7', name: 'Goal Crusher', icon: 'ðŸŽ¯', desc: 'Hit daily goal 7 days in a row', check: (d) => d.achievements?.['goal-streak-7'] },
            { id: 'cloud-sync', name: 'Cloud Gamer', icon: 'â˜ï¸', desc: 'Sign in and sync to cloud', check: (d) => d.achievements?.['cloud-sync'] },
        ];

        // ============ AUTHENTICATION ============
        function signInWithGoogle() {
            if (!isFirebaseReady || !auth) {
                showToast('Sign-in not available', 'error');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Signed in:', result.user.displayName);
                    showToast(`Welcome, ${result.user.displayName}!`);
                })
                .catch((error) => {
                    console.error('Sign-in error:', error);
                    showToast('Sign-in failed: ' + error.message);
                });
        }

        function signOut() {
            if (auth) {
                auth.signOut().then(() => {
                    showToast('Signed out');
                    closeProfileModal();
                });
            }
        }

        function handleAuthStateChange(user) {
            currentUser = user;
            
            const signInBtn = document.getElementById('sign-in-btn');
            const avatarBtn = document.getElementById('user-avatar-btn');
            const avatar = document.getElementById('user-avatar');
            const friendsSigninPrompt = document.getElementById('friends-signin-prompt');
            const friendsContent = document.getElementById('friends-content');
            
            if (user) {
                // User is signed in
                signInBtn.style.display = 'none';
                avatarBtn.style.display = 'block';
                avatar.src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" text-anchor="middle" font-size="40" fill="%23fff">' + (user.displayName?.[0] || '?') + '</text></svg>';
                
                // Show friends content
                if (friendsSigninPrompt) friendsSigninPrompt.style.display = 'none';
                if (friendsContent) friendsContent.style.display = 'block';
                
                // Load from cloud, merge with local
                loadFromCloud(user.uid);
                
                // Load friends data
                loadFriendsData(user.uid);
                
                // Unlock cloud sync achievement
                if (!userData.achievements['cloud-sync']) {
                    userData.achievements['cloud-sync'] = getTodayString();
                    saveData();
                    checkAndUnlockAchievements();
                }
            } else {
                // User is signed out
                signInBtn.style.display = 'flex';
                avatarBtn.style.display = 'none';
                updateSyncIndicator('offline');
                
                // Show signin prompt, hide friends content
                if (friendsSigninPrompt) friendsSigninPrompt.style.display = 'block';
                if (friendsContent) friendsContent.style.display = 'none';
            }
        }

        // ============ FRIENDS & LEADERBOARD ============
        let friendsData = [];
        let friendsActivity = [];

        async function loadFriendsData(uid) {
            if (!isFirebaseReady || !db) return;
            
            try {
                // Load friends list from shared friends path (same as Word Boxing)
                const friendsSnapshot = await db.ref('friends/' + uid).once('value');
                const friendsObj = friendsSnapshot.val() || {};
                
                friendsData = Object.values(friendsObj);
                
                // Update friends count
                const countEl = document.getElementById('friends-count');
                if (countEl) countEl.textContent = friendsData.length;
                
                // Load each friend's gameshelf data for leaderboard
                await loadFriendsShelfData(friendsData);
                
                // Render UI
                renderFriendsList();
                renderLeaderboard();
                renderActivityFeed();
                
            } catch (error) {
                console.error('Failed to load friends:', error);
            }
        }

        async function loadFriendsShelfData(friends) {
            if (!isFirebaseReady || !db) return;
            
            const today = getTodayString();
            const activities = [];
            
            for (const friend of friends) {
                try {
                    // Try to get their public gameshelf stats
                    const shelfSnapshot = await db.ref('gameshelf-public/' + friend.odid).once('value');
                    const shelfData = shelfSnapshot.val();
                    
                    if (shelfData) {
                        friend.shelfData = shelfData;
                        
                        // Build activity from their recent plays
                        if (shelfData.lastActivity) {
                            activities.push({
                                odid: friend.odid,
                                displayName: friend.displayName,
                                photoURL: shelfData.photoURL,
                                ...shelfData.lastActivity
                            });
                        }
                    }
                } catch (e) {
                    // Friend may not have public shelf data
                }
            }
            
            // Sort activities by timestamp (newest first)
            friendsActivity = activities.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)).slice(0, 10);
        }

        function renderFriendsList() {
            const listEl = document.getElementById('friends-list');
            if (!listEl) return;
            
            if (friendsData.length === 0) {
                listEl.innerHTML = `
                    <div class="activity-empty">
                        <p>No friends added yet</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">Add friends from Word Boxing or share your friend code!</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = friendsData.map(friend => {
                const todayPlayed = friend.shelfData?.todayCount || 0;
                const statusClass = todayPlayed > 0 ? 'active' : '';
                const statusText = todayPlayed > 0 ? `${todayPlayed} games today` : 'No activity today';
                
                return `
                    <div class="friend-item">
                        <img class="friend-avatar" src="${friend.photoURL || generateAvatarUrl(friend.displayName)}" alt="">
                        <div class="friend-info">
                            <div class="friend-name">${friend.displayName}</div>
                            <div class="friend-status ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard() {
            const leaderboardEl = document.getElementById('daily-leaderboard');
            if (!leaderboardEl) return;
            
            // Build leaderboard data
            const today = getTodayString();
            const leaderboardData = [];
            
            // Add current user
            if (currentUser) {
                let userTodayCount = 0;
                Object.values(userData.stats).forEach(stat => {
                    if (stat && stat.lastPlayed === today) userTodayCount++;
                });
                
                leaderboardData.push({
                    odid: currentUser.uid,
                    displayName: currentUser.displayName || 'You',
                    photoURL: currentUser.photoURL,
                    todayCount: userTodayCount,
                    isCurrentUser: true
                });
            }
            
            // Add friends
            friendsData.forEach(friend => {
                leaderboardData.push({
                    odid: friend.odid,
                    displayName: friend.displayName,
                    photoURL: friend.photoURL || friend.shelfData?.photoURL,
                    todayCount: friend.shelfData?.todayCount || 0,
                    isCurrentUser: false
                });
            });
            
            // Sort by games played today
            leaderboardData.sort((a, b) => b.todayCount - a.todayCount);
            
            if (leaderboardData.length <= 1) {
                leaderboardEl.innerHTML = `
                    <div class="leaderboard-empty">
                        <p>Add friends to compete!</p>
                    </div>
                `;
                return;
            }
            
            leaderboardEl.innerHTML = leaderboardData.slice(0, 10).map((entry, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const rankEmoji = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : (index + 1);
                
                return `
                    <div class="leaderboard-item ${entry.isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-rank ${rankClass}">${rankEmoji}</div>
                        <img class="leaderboard-avatar" src="${entry.photoURL || generateAvatarUrl(entry.displayName)}" alt="">
                        <div class="leaderboard-name">${entry.isCurrentUser ? 'You' : entry.displayName}</div>
                        <div class="leaderboard-score">${entry.todayCount} <span>games</span></div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityFeed() {
            const feedEl = document.getElementById('activity-feed');
            if (!feedEl) return;
            
            if (friendsActivity.length === 0) {
                feedEl.innerHTML = `
                    <div class="activity-empty">
                        <p>No recent activity from friends</p>
                    </div>
                `;
                return;
            }
            
            feedEl.innerHTML = friendsActivity.map(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const gameIcon = getGameIcon(activity.gameId);
                
                return `
                    <div class="activity-item">
                        <img class="activity-avatar" src="${activity.photoURL || generateAvatarUrl(activity.displayName)}" alt="">
                        <div class="activity-content">
                            <div class="activity-text"><strong>${activity.displayName}</strong> played ${activity.gameName || activity.gameId}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                        <div class="activity-game-icon">${gameIcon}</div>
                    </div>
                `;
            }).join('');
        }

        function generateAvatarUrl(name) {
            const initial = (name || '?')[0].toUpperCase();
            return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23667eea"/><text x="50" y="65" text-anchor="middle" font-size="40" fill="%23fff">${initial}</text></svg>`;
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Recently';
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            return `${days} days ago`;
        }

        function getGameIcon(gameId) {
            const icons = {
                'wordle': 'ðŸŸ©',
                'connections': 'ðŸ”—',
                'strands': 'ðŸ§µ',
                'spelling-bee': 'ðŸ',
                'mini': 'ðŸ“',
                'letterboxed': 'ðŸ“¦',
                'quordle': '4ï¸âƒ£',
                'octordle': '8ï¸âƒ£',
                'worldle': 'ðŸŒ',
                'globle': 'ðŸŒŽ',
                'framed': 'ðŸŽ¬',
                'nerdle': 'ðŸ§®'
            };
            return icons[gameId] || 'ðŸŽ®';
        }

        async function publishActivity(gameId, gameName) {
            if (!isFirebaseReady || !db || !currentUser) return;
            
            try {
                const today = getTodayString();
                let todayCount = 0;
                Object.values(userData.stats).forEach(stat => {
                    if (stat && stat.lastPlayed === today) todayCount++;
                });
                
                // Publish public data for friends to see
                await db.ref('gameshelf-public/' + currentUser.uid).set({
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    todayCount: todayCount,
                    lastActivity: {
                        gameId: gameId,
                        gameName: gameName,
                        timestamp: Date.now()
                    }
                });
            } catch (e) {
                console.error('Failed to publish activity:', e);
            }
        }

        function showAddFriendModal() {
            // Generate a short code from UID
            const shortCode = currentUser ? currentUser.uid.substring(0, 8).toUpperCase() : '--------';
            const fullUid = currentUser ? currentUser.uid : '';
            const shareLink = `${window.location.origin}${window.location.pathname}?addFriend=${fullUid}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareLink)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'add-friend-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <h2>ðŸ‘¥ Add Friend</h2>
                    
                    <!-- Tab buttons -->
                    <div class="friend-tabs" style="display: flex; gap: 5px; margin: 15px 0;">
                        <button class="ext-tab active" onclick="showFriendTab('share')">Share Link</button>
                        <button class="ext-tab" onclick="showFriendTab('qr')">QR Code</button>
                        <button class="ext-tab" onclick="showFriendTab('code')">Enter Code</button>
                    </div>
                    
                    <!-- Share Link Tab -->
                    <div class="friend-tab-content" id="friend-tab-share">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Send this link to a friend:</p>
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 0.75rem; color: var(--accent-gold);">
                            ${shareLink}
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="copyFriendLink('${shareLink}')" style="flex:1">ðŸ“‹ Copy Link</button>
                            <button class="btn btn-secondary" onclick="shareFriendLink('${shareLink}')">ðŸ“¤ Share</button>
                        </div>
                    </div>
                    
                    <!-- QR Code Tab -->
                    <div class="friend-tab-content" id="friend-tab-qr" style="display: none;">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Scan to add as friend:</p>
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 12px; display: inline-block; margin: 0 auto; width: 100%;">
                            <img src="${qrCodeUrl}" alt="QR Code" style="max-width: 150px;">
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 10px;">
                            Works with any QR scanner app
                        </p>
                    </div>
                    
                    <!-- Enter Code Tab -->
                    <div class="friend-tab-content" id="friend-tab-code" style="display: none;">
                        <div class="friend-code-display">
                            <div class="friend-code-label">Your Friend Code</div>
                            <div class="friend-code">${shortCode}</div>
                            <button class="btn btn-secondary" onclick="copyFriendCode('${shortCode}')" style="margin-top: 10px;">ðŸ“‹ Copy Code</button>
                        </div>
                        <p style="color: var(--text-secondary); margin: 15px 0;">Or enter a friend's code:</p>
                        <input type="text" class="friend-code-input" id="friend-code-input" placeholder="ABCD1234" maxlength="8">
                        <button class="btn btn-primary" onclick="addFriendByCode()" style="width: 100%; margin-top: 10px;">Add Friend</button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeAddFriendModal()" style="flex:1">Close</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 15px;">
                        ðŸ’¡ Friends are shared with Word Boxing!
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showFriendTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.friend-tabs .ext-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all tabs
            document.querySelectorAll('.friend-tab-content').forEach(tab => tab.style.display = 'none');
            
            // Show selected tab
            document.getElementById('friend-tab-' + tabName).style.display = 'block';
        }

        function copyFriendLink(link) {
            navigator.clipboard.writeText(link);
            showToast('Friend link copied!');
        }

        function shareFriendLink(link) {
            if (navigator.share) {
                navigator.share({
                    title: 'Add me on Game Shelf!',
                    text: 'Track daily puzzles together on Game Shelf',
                    url: link
                });
            } else {
                copyFriendLink(link);
            }
        }

        function closeAddFriendModal() {
            const modal = document.getElementById('add-friend-modal');
            if (modal) modal.remove();
        }

        function copyFriendCode(code) {
            navigator.clipboard.writeText(code);
            showToast('Friend code copied!');
        }

        async function addFriendByCode() {
            const codeInput = document.getElementById('friend-code-input');
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 8) {
                showToast('Please enter a valid 8-character code');
                return;
            }
            
            showToast('Looking up friend...');
            // Note: In a full implementation, you'd need a lookup table
            // mapping short codes to full UIDs
            closeAddFriendModal();
        }

        // ============ CLOUD SYNC ============
        async function loadFromCloud(uid) {
            if (!isFirebaseReady || !db) return;
            
            updateSyncIndicator('syncing');
            
            try {
                const snapshot = await db.ref('gameshelf/' + uid).once('value');
                const cloudData = snapshot.val();
                
                if (cloudData) {
                    // Merge cloud data with local data (cloud wins for conflicts)
                    userData = mergeUserData(userData, cloudData);
                    saveData(); // Save merged data locally
                    
                    // Re-render everything
                    renderAll();
                    showToast('â˜ï¸ Synced from cloud');
                } else {
                    // No cloud data, push local data to cloud
                    await saveToCloud();
                }
                
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Cloud load error:', error);
                updateSyncIndicator('offline');
            }
        }

        async function saveToCloud() {
            if (!isFirebaseReady || !db || !currentUser) return;
            
            updateSyncIndicator('syncing');
            
            try {
                await db.ref('gameshelf/' + currentUser.uid).set({
                    ...userData,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    displayName: currentUser.displayName,
                    email: currentUser.email
                });
                
                updateSyncIndicator('synced');
            } catch (error) {
                console.error('Cloud save error:', error);
                updateSyncIndicator('offline');
            }
        }

        function mergeUserData(local, cloud) {
            // Smart merge: combine arrays, take higher values for stats
            const merged = { ...local };
            
            // Merge games (combine unique games)
            const localGameIds = new Set(local.games?.map(g => g.id) || []);
            const cloudGames = cloud.games || [];
            cloudGames.forEach(g => {
                if (!localGameIds.has(g.id)) {
                    merged.games.push(g);
                }
            });
            
            // Merge stats (take higher values)
            merged.stats = { ...local.stats };
            Object.entries(cloud.stats || {}).forEach(([key, cloudStat]) => {
                if (typeof cloudStat === 'object') {
                    const localStat = local.stats?.[key] || {};
                    merged.stats[key] = {
                        streak: Math.max(cloudStat.streak || 0, localStat.streak || 0),
                        totalPlays: Math.max(cloudStat.totalPlays || 0, localStat.totalPlays || 0),
                        lastPlayed: cloudStat.lastPlayed > localStat.lastPlayed ? cloudStat.lastPlayed : localStat.lastPlayed
                    };
                } else {
                    merged.stats[key] = Math.max(cloudStat || 0, local.stats?.[key] || 0);
                }
            });
            
            // Merge achievements (combine)
            merged.achievements = { ...local.achievements, ...cloud.achievements };
            
            // Merge history (combine days)
            merged.history = { ...local.history, ...cloud.history };
            
            // Merge reviews (cloud wins)
            merged.reviews = { ...local.reviews, ...cloud.reviews };
            
            // Take cloud dailyGoal if set
            if (cloud.dailyGoal) merged.dailyGoal = cloud.dailyGoal;
            
            // Registration status
            merged.registered = local.registered || cloud.registered;
            
            return merged;
        }

        function updateSyncIndicator(status) {
            syncStatus = status;
            const indicator = document.getElementById('sync-indicator');
            const statusEl = document.getElementById('sync-status');
            const statusText = document.getElementById('sync-status-text');
            
            if (indicator) {
                indicator.className = 'sync-indicator ' + status;
            }
            
            if (statusEl && statusText) {
                statusEl.className = 'sync-status ' + status;
                switch (status) {
                    case 'synced':
                        statusText.textContent = 'Synced to cloud';
                        break;
                    case 'syncing':
                        statusText.textContent = 'Syncing...';
                        break;
                    case 'offline':
                        statusText.textContent = 'Local only';
                        break;
                }
            }
        }

        async function syncNow() {
            if (!currentUser) {
                showToast('Sign in to sync');
                return;
            }
            
            await saveToCloud();
            showToast('â˜ï¸ Synced!');
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profile-avatar').src = currentUser.photoURL || '';
            document.getElementById('profile-name').textContent = currentUser.displayName || 'Player';
            document.getElementById('profile-email').textContent = currentUser.email || '';
            
            // Stats
            document.getElementById('profile-games-played').textContent = userData.stats?.totalCompleted || 0;
            
            let bestStreak = 0;
            Object.values(userData.stats || {}).forEach(stat => {
                if (typeof stat === 'object' && stat.streak > bestStreak) {
                    bestStreak = stat.streak;
                }
            });
            document.getElementById('profile-best-streak').textContent = bestStreak;
            document.getElementById('profile-achievements').textContent = Object.keys(userData.achievements || {}).length;
            
            document.getElementById('profile-modal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function renderAll() {
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            updateSharePreview();
            renderCalendar();
            renderAchievements();
            updateDailyGoal();
            renderInsights();
        }

        // ============ INIT ============
        function init() {
            loadData();
            loadTheme();
            
            // Set up Firebase auth listener
            if (isFirebaseReady && auth) {
                auth.onAuthStateChanged(handleAuthStateChange);
            }
            
            if (!userData.registered) {
                showWelcome();
            }
            
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            updateSharePreview();
            setupStarRating();
            renderCalendar();
            renderAchievements();
            checkTimeAchievements();
            updateDailyGoal();
            renderInsights();
            generateShareLink();
            
            // Handle Share Target API (when app receives shared content)
            handleIncomingShare();
            
            // Start clipboard monitoring
            startClipboardMonitoring();
            
            // Check for pending friend add (from before sign-in)
            checkPendingFriend();
            
            // Suggest smart goal
            suggestSmartGoal();
            
            // Generate smart game suggestion
            setTimeout(generateSmartSuggestion, 1000);
        }

        // ============ CLIPBOARD MONITORING ============
        let lastClipboardText = '';
        let clipboardCheckInterval = null;
        
        function startClipboardMonitoring() {
            // Check clipboard and return-from-game when tab is focused
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    checkClipboard();
                    checkReturnFromGame();
                }
            });
            
            // Also check on window focus
            window.addEventListener('focus', () => {
                checkClipboard();
                checkReturnFromGame();
            });
            
            // Check periodically (less frequently to save resources)
            clipboardCheckInterval = setInterval(() => {
                if (document.hasFocus()) {
                    checkClipboard();
                }
            }, 3000);
            
            // Check streak risks on load
            setTimeout(checkStreakRisks, 2000);
        }
        
        // ============ RETURN FROM GAME DETECTION ============
        function checkReturnFromGame() {
            // Only show if returned within 30 minutes of clicking a game
            if (!lastPlayedGame || !lastPlayedTime) return;
            
            const timeSinceClick = Date.now() - lastPlayedTime;
            const thirtyMinutes = 30 * 60 * 1000;
            
            if (timeSinceClick > thirtyMinutes) {
                lastPlayedGame = null;
                return;
            }
            
            // Don't show if already showing a prompt
            if (document.getElementById('return-prompt') || document.getElementById('clipboard-prompt')) {
                return;
            }
            
            showReturnPrompt(lastPlayedGame);
        }
        
        function showReturnPrompt(game) {
            const prompt = document.createElement('div');
            prompt.id = 'return-prompt';
            prompt.innerHTML = `
                <style>
                    #return-prompt {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                        border: 2px solid var(--accent-purple);
                        border-radius: 16px;
                        padding: 15px 20px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        animation: slideUp 0.3s ease;
                        max-width: 90%;
                    }
                    #return-prompt .prompt-icon { font-size: 2rem; }
                    #return-prompt .prompt-content { flex: 1; }
                    #return-prompt .prompt-title { font-weight: 700; color: var(--accent-purple); }
                    #return-prompt .prompt-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
                    #return-prompt .prompt-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                    #return-prompt button { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
                    #return-prompt .btn-log { background: var(--accent-purple); color: #fff; }
                    #return-prompt .btn-dismiss { background: var(--bg-hover); color: var(--text-secondary); }
                </style>
                <div class="prompt-icon">${game.icon}</div>
                <div class="prompt-content">
                    <div class="prompt-title">Back from ${game.name}?</div>
                    <div class="prompt-subtitle">Log your result to track stats!</div>
                </div>
                <div class="prompt-actions">
                    <button class="btn-log" onclick="openQuickLogFromReturn()">ðŸ“‹ Log Result</button>
                    <button class="btn-dismiss" onclick="dismissReturnPrompt()">Later</button>
                </div>
            `;
            
            document.body.appendChild(prompt);
            
            // Clear the tracked game
            lastPlayedGame = null;
            
            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                dismissReturnPrompt();
            }, 15000);
        }
        
        function openQuickLogFromReturn() {
            dismissReturnPrompt();
            toggleQuickLog();
        }
        
        function dismissReturnPrompt() {
            const prompt = document.getElementById('return-prompt');
            if (prompt) {
                prompt.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => prompt.remove(), 300);
            }
        }
        
        // ============ STREAK RISK ALERTS ============
        function checkStreakRisks() {
            const today = getTodayString();
            const yesterday = getYesterdayString();
            const atRiskGames = [];
            
            // Check featured games
            FEATURED_GAMES.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    atRiskGames.push({ ...game, streak: stats.streak });
                }
            });
            
            // Check user's games
            userData.games.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    atRiskGames.push({ ...game, streak: stats.streak });
                }
            });
            
            if (atRiskGames.length > 0) {
                showStreakRiskBanner(atRiskGames);
            }
        }
        
        function showStreakRiskBanner(games) {
            // Don't show if already shown today
            const shownToday = sessionStorage.getItem('streakBannerShown') === getTodayString();
            if (shownToday) return;
            
            const banner = document.createElement('div');
            banner.id = 'streak-risk-banner';
            banner.innerHTML = `
                <style>
                    #streak-risk-banner {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                        color: white;
                        padding: 12px 20px;
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 15px;
                        animation: slideDown 0.3s ease;
                        flex-wrap: wrap;
                    }
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                    #streak-risk-banner .banner-text { font-weight: 600; }
                    #streak-risk-banner .banner-games { display: flex; gap: 8px; }
                    #streak-risk-banner .banner-game {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 0.85rem;
                        cursor: pointer;
                    }
                    #streak-risk-banner .banner-game:hover {
                        background: rgba(255,255,255,0.3);
                    }
                    #streak-risk-banner .banner-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 1.2rem;
                        cursor: pointer;
                        opacity: 0.7;
                        padding: 5px;
                    }
                    #streak-risk-banner .banner-close:hover { opacity: 1; }
                </style>
                <span class="banner-text">ðŸ”¥ Streak${games.length > 1 ? 's' : ''} at risk!</span>
                <div class="banner-games">
                    ${games.slice(0, 3).map(g => `
                        <span class="banner-game" onclick="playGame('${g.id}', '${g.url}', false, '${g.name}')">
                            ${g.icon} ${g.name} (${g.streak} days)
                        </span>
                    `).join('')}
                    ${games.length > 3 ? `<span class="banner-game">+${games.length - 3} more</span>` : ''}
                </div>
                <button class="banner-close" onclick="dismissStreakBanner()">âœ•</button>
            `;
            
            document.body.appendChild(banner);
            
            // Shift content down
            document.querySelector('.container').style.marginTop = '60px';
            
            sessionStorage.setItem('streakBannerShown', getTodayString());
        }
        
        function dismissStreakBanner() {
            const banner = document.getElementById('streak-risk-banner');
            if (banner) {
                banner.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => {
                    banner.remove();
                    document.querySelector('.container').style.marginTop = '0';
                }, 300);
            }
        }
        
        async function checkClipboard() {
            try {
                // Need permission - this will prompt user first time
                const text = await navigator.clipboard.readText();
                
                if (text && text !== lastClipboardText) {
                    lastClipboardText = text;
                    
                    // Check if it matches a game pattern
                    for (const game of GAME_PATTERNS) {
                        if (game.pattern.test(text)) {
                            showClipboardPrompt(text, game);
                            break;
                        }
                    }
                }
            } catch (e) {
                // Permission denied or not supported - that's okay
            }
        }
        
        function showClipboardPrompt(text, game) {
            // Don't show if already logged today for this game
            const today = getTodayString();
            if (userData.stats[game.id]?.lastPlayed === today) {
                return;
            }
            
            // Don't show if prompt already visible
            if (document.getElementById('clipboard-prompt')) {
                return;
            }
            
            const extracted = game.extract(text.match(game.pattern), text);
            
            const prompt = document.createElement('div');
            prompt.id = 'clipboard-prompt';
            prompt.innerHTML = `
                <style>
                    #clipboard-prompt {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                        border: 2px solid var(--accent-gold);
                        border-radius: 16px;
                        padding: 15px 20px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        animation: slideUp 0.3s ease;
                        max-width: 90%;
                    }
                    @keyframes slideUp {
                        from { transform: translateX(-50%) translateY(100%); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                    #clipboard-prompt .prompt-icon { font-size: 2rem; }
                    #clipboard-prompt .prompt-content { flex: 1; }
                    #clipboard-prompt .prompt-title { font-weight: 700; color: var(--accent-gold); }
                    #clipboard-prompt .prompt-subtitle { font-size: 0.85rem; color: var(--text-secondary); }
                    #clipboard-prompt .prompt-actions { display: flex; gap: 8px; }
                    #clipboard-prompt button { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
                    #clipboard-prompt .btn-log { background: var(--accent-gold); color: #000; }
                    #clipboard-prompt .btn-dismiss { background: var(--bg-hover); color: var(--text-secondary); }
                </style>
                <div class="prompt-icon">${game.icon}</div>
                <div class="prompt-content">
                    <div class="prompt-title">${game.name} detected!</div>
                    <div class="prompt-subtitle">${extracted.score}</div>
                </div>
                <div class="prompt-actions">
                    <button class="btn-log" onclick="logFromClipboard()">âœ“ Log</button>
                    <button class="btn-dismiss" onclick="dismissClipboardPrompt()">âœ•</button>
                </div>
            `;
            
            document.body.appendChild(prompt);
            
            // Store text for logging
            prompt.dataset.text = text;
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                dismissClipboardPrompt();
            }, 10000);
        }
        
        function logFromClipboard() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt && prompt.dataset.text) {
                const input = document.getElementById('parse-input');
                if (input) input.value = prompt.dataset.text;
                parseShareText();
            }
            dismissClipboardPrompt();
        }
        
        function dismissClipboardPrompt() {
            const prompt = document.getElementById('clipboard-prompt');
            if (prompt) {
                prompt.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => prompt.remove(), 300);
            }
        }

        // ============ SMART SUGGESTIONS ============
        function checkPendingFriend() {
            const pendingFriend = sessionStorage.getItem('pendingFriend');
            if (pendingFriend && currentUser) {
                sessionStorage.removeItem('pendingFriend');
                handleFriendLink(pendingFriend);
            }
        }
        
        function suggestSmartGoal() {
            // Only suggest if user hasn't set a custom goal
            if (userData.dailyGoal && userData.dailyGoal !== 5) return;
            
            // Calculate average games per day from history
            const history = userData.history || [];
            if (history.length < 7) return; // Need at least a week of data
            
            const dayCounts = {};
            history.forEach(entry => {
                const day = entry.date;
                if (!dayCounts[day]) dayCounts[day] = 0;
                dayCounts[day]++;
            });
            
            const counts = Object.values(dayCounts);
            const avg = counts.reduce((a, b) => a + b, 0) / counts.length;
            
            // Suggest a goal slightly above average
            const suggestedGoal = Math.ceil(avg) + 1;
            
            if (suggestedGoal !== userData.dailyGoal && suggestedGoal >= 3 && suggestedGoal <= 10) {
                // Store suggestion for goal modal
                userData.suggestedGoal = suggestedGoal;
            }
        }

        // ============ SMART GAME SUGGESTIONS ============
        let currentSuggestion = null;
        
        function generateSmartSuggestion() {
            const today = getTodayString();
            const yesterday = getYesterdayString();
            const hour = new Date().getHours();
            const suggestions = [];
            
            // 1. Streak at risk suggestions (highest priority)
            const allGames = [...FEATURED_GAMES, ...userData.games];
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > 1 && stats.lastPlayed === yesterday) {
                    suggestions.push({
                        priority: 10,
                        icon: 'ðŸ”¥',
                        text: `Don't lose your ${stats.streak}-day ${game.name} streak!`,
                        action: 'Play Now',
                        game: game
                    });
                }
            });
            
            // 2. Time-based suggestions
            if (hour >= 6 && hour < 10) {
                // Morning - suggest quick games
                const mini = POPULAR_GAMES.find(g => g.id === 'mini');
                if (mini && userData.stats['mini']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: 'â˜€ï¸',
                        text: 'Good morning! The Mini is perfect for a quick start.',
                        action: 'Play Mini',
                        game: mini
                    });
                }
            } else if (hour >= 10 && hour < 14) {
                // Late morning/lunch - suggest Wordle
                const wordle = POPULAR_GAMES.find(g => g.id === 'wordle');
                if (wordle && userData.stats['wordle']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: 'ðŸŸ©',
                        text: "Have you done today's Wordle yet?",
                        action: 'Play Wordle',
                        game: wordle
                    });
                }
            } else if (hour >= 17 && hour < 21) {
                // Evening - suggest longer games
                const connections = POPULAR_GAMES.find(g => g.id === 'connections');
                if (connections && userData.stats['connections']?.lastPlayed !== today) {
                    suggestions.push({
                        priority: 5,
                        icon: 'ðŸ”—',
                        text: 'Evening puzzle time! Try Connections.',
                        action: 'Play',
                        game: connections
                    });
                }
            }
            
            // 3. Goal progress suggestion
            const goalCount = getCurrentGoalCount();
            const goal = userData.dailyGoal || 5;
            if (goalCount < goal) {
                const remaining = goal - goalCount;
                const unplayedGame = allGames.find(g => userData.stats[g.id]?.lastPlayed !== today);
                if (unplayedGame && remaining <= 2) {
                    suggestions.push({
                        priority: 4,
                        icon: 'ðŸŽ¯',
                        text: `Just ${remaining} more game${remaining > 1 ? 's' : ''} to hit your daily goal!`,
                        action: 'Play',
                        game: unplayedGame
                    });
                }
            }
            
            // 4. Encourage trying new games
            if (suggestions.length === 0 && userData.games.length < 3) {
                suggestions.push({
                    priority: 1,
                    icon: 'ðŸ”',
                    text: 'Discover new puzzles in the Discover tab!',
                    action: 'Explore',
                    game: null,
                    customAction: () => switchTab('discover')
                });
            }
            
            // Sort by priority and pick the best one
            suggestions.sort((a, b) => b.priority - a.priority);
            
            if (suggestions.length > 0) {
                currentSuggestion = suggestions[0];
                showSmartSuggestion(currentSuggestion);
            }
        }
        
        function getCurrentGoalCount() {
            const today = getTodayString();
            let count = 0;
            Object.values(userData.stats).forEach(stat => {
                if (stat && stat.lastPlayed === today) count++;
            });
            return count;
        }
        
        function showSmartSuggestion(suggestion) {
            const container = document.getElementById('smart-suggestion');
            if (!container) return;
            
            // Don't show if dismissed today
            const dismissedToday = sessionStorage.getItem('suggestionDismissed') === getTodayString();
            if (dismissedToday) return;
            
            document.getElementById('suggestion-icon').textContent = suggestion.icon;
            document.getElementById('suggestion-text').textContent = suggestion.text;
            document.getElementById('suggestion-action').textContent = suggestion.action;
            
            container.style.display = 'flex';
        }
        
        function actOnSuggestion() {
            if (!currentSuggestion) return;
            
            if (currentSuggestion.customAction) {
                currentSuggestion.customAction();
            } else if (currentSuggestion.game) {
                playGame(
                    currentSuggestion.game.id, 
                    currentSuggestion.game.url, 
                    currentSuggestion.game.featured || false,
                    currentSuggestion.game.name
                );
            }
            
            dismissSuggestion();
        }
        
        function dismissSuggestion() {
            const container = document.getElementById('smart-suggestion');
            if (container) {
                container.style.display = 'none';
            }
            sessionStorage.setItem('suggestionDismissed', getTodayString());
        }

        // ============ SHARE TARGET HANDLER ============
        function handleIncomingShare() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedText = urlParams.get('text');
            const sharedTitle = urlParams.get('title');
            const sharedUrl = urlParams.get('url');
            const syncData = urlParams.get('sync');
            const addFriendId = urlParams.get('addFriend');
            
            // Handle friend link
            if (addFriendId) {
                window.history.replaceState({}, document.title, window.location.pathname);
                setTimeout(() => {
                    handleFriendLink(addFriendId);
                }, 1000); // Wait for auth
                return;
            }
            
            // Handle extension sync data
            if (syncData) {
                try {
                    const games = JSON.parse(decodeURIComponent(syncData));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    setTimeout(() => {
                        processExtensionSync(games);
                    }, 500);
                    return;
                } catch (e) {
                    console.error('Failed to parse sync data:', e);
                }
            }
            
            // Combine all shared data
            let fullText = '';
            if (sharedTitle) fullText += sharedTitle + '\n';
            if (sharedText) fullText += sharedText + '\n';
            if (sharedUrl) fullText += sharedUrl;
            
            if (fullText.trim()) {
                // Clean URL (remove params)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Auto-process the shared text
                setTimeout(() => {
                    processSharedText(fullText.trim());
                }, 500);
            }
        }

        async function handleFriendLink(friendUid) {
            if (!currentUser) {
                showToast('Sign in to add friends!');
                // Store for after sign in
                sessionStorage.setItem('pendingFriend', friendUid);
                return;
            }
            
            if (friendUid === currentUser.uid) {
                showToast("That's your own link!");
                return;
            }
            
            // Fetch friend's public data
            try {
                const snapshot = await db.ref('gameshelf-public/' + friendUid).once('value');
                const friendData = snapshot.val();
                
                if (!friendData) {
                    showToast('Friend not found');
                    return;
                }
                
                // Show confirmation modal
                showFriendConfirmModal(friendUid, friendData);
            } catch (e) {
                console.error('Failed to fetch friend:', e);
                showToast('Could not find friend');
            }
        }

        function showFriendConfirmModal(friendUid, friendData) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'friend-confirm-modal';
            modal.innerHTML = `
                <div class="modal" style="text-align: center;">
                    <h2>ðŸ‘¥ Add Friend?</h2>
                    <div style="margin: 20px 0;">
                        <img src="${friendData.photoURL || generateAvatarUrl(friendData.displayName)}" 
                             style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary);">
                            ${friendData.displayName}
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">
                            ${friendData.todayCount || 0} games played today
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="confirmAddFriend('${friendUid}', '${friendData.displayName}')" style="flex:1">
                            âœ“ Add Friend
                        </button>
                        <button class="btn btn-secondary" onclick="closeFriendConfirmModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeFriendConfirmModal() {
            const modal = document.getElementById('friend-confirm-modal');
            if (modal) modal.remove();
        }

        async function confirmAddFriend(friendUid, displayName) {
            if (!currentUser || !isFirebaseReady) {
                showToast('Please sign in first');
                return;
            }
            
            try {
                // Add to friends list
                await db.ref('friends/' + currentUser.uid + '/' + friendUid).set({
                    odid: friendUid,
                    displayName: displayName,
                    addedAt: Date.now()
                });
                
                closeFriendConfirmModal();
                showToast('âœ“ Friend added!');
                
                // Reload friends
                loadFriendsData(currentUser.uid);
                
            } catch (e) {
                console.error('Failed to add friend:', e);
                showToast('Could not add friend');
            }
        }

        function processExtensionSync(games) {
            if (!Array.isArray(games) || games.length === 0) return;
            
            let syncedCount = 0;
            
            games.forEach(game => {
                const gameId = game.id;
                const gameDate = game.date || getTodayString();
                
                if (!userData.stats[gameId]) {
                    userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
                
                // Only update if not already logged for this date
                if (userData.stats[gameId].lastPlayed !== gameDate) {
                    const prevDate = userData.stats[gameId].lastPlayed;
                    
                    // Calculate if this continues a streak
                    const gameDay = new Date(gameDate);
                    const prevDay = prevDate ? new Date(prevDate) : null;
                    const dayDiff = prevDay ? Math.floor((gameDay - prevDay) / 86400000) : 999;
                    
                    if (dayDiff === 1) {
                        userData.stats[gameId].streak++;
                    } else {
                        userData.stats[gameId].streak = 1;
                    }
                    
                    userData.stats[gameId].lastPlayed = gameDate;
                    userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                    
                    if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                    userData.stats.totalCompleted++;
                    
                    // Publish activity
                    publishActivity(gameId, game.name || gameId);
                    
                    syncedCount++;
                }
            });
            
            if (syncedCount > 0) {
                saveData();
                recordHistory();
                
                // Update UI
                renderFeaturedGames();
                renderMyGames();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                renderLeaderboard();
                checkAndUnlockAchievements();
                
                showToast(`âœ“ Synced ${syncedCount} game${syncedCount > 1 ? 's' : ''} from extension!`);
            } else {
                showToast('All games already logged!');
            }
        }

        function processSharedText(text) {
            // Put the text in the parse input
            const input = document.getElementById('parse-input');
            if (input) {
                input.value = text;
            }
            
            // Try to parse it
            let matched = false;
            
            for (const game of GAME_PATTERNS) {
                const match = text.match(game.pattern);
                if (match) {
                    const extracted = game.extract(match, text);
                    
                    // Mark the game as played
                    const gameId = game.id;
                    const today = getTodayString();
                    
                    if (!userData.stats[gameId]) {
                        userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                    }
                    
                    if (userData.stats[gameId].lastPlayed !== today) {
                        const yesterday = getYesterdayString();
                        if (userData.stats[gameId].lastPlayed === yesterday) {
                            userData.stats[gameId].streak++;
                        } else {
                            userData.stats[gameId].streak = 1;
                        }
                        userData.stats[gameId].lastPlayed = today;
                        userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                        
                        if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                        userData.stats.totalCompleted++;
                    }
                    
                    saveData();
                    recordHistory();
                    
                    // Update UI
                    renderFeaturedGames();
                    renderMyGames();
                    updateStats();
                    renderCalendar();
                    updateDailyGoal();
                    renderInsights();
                    checkAndUnlockAchievements();
                    unlockTimeAchievement();
                    
                    // Show success with game info
                    showShareSuccessModal(game, extracted);
                    
                    matched = true;
                    break;
                }
            }
            
            if (!matched) {
                showToast('Could not detect game. Try pasting manually.');
                // Switch to games tab and scroll to parser
                switchTab('games');
            }
        }

        function showShareSuccessModal(game, result) {
            // Create a quick success overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.id = 'share-success-modal';
            overlay.innerHTML = `
                <div class="modal" style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">${game.icon}</div>
                    <h2 style="color: var(--accent-green);">âœ“ Logged!</h2>
                    <p style="font-size: 1.3rem; margin: 15px 0; color: var(--text-primary);">${game.name}</p>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${result.score}</p>
                    <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: center; gap: 30px;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent-gold);">${userData.stats[game.id]?.streak || 1}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">STREAK</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent-gold);">${userData.stats[game.id]?.totalPlays || 1}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">TOTAL</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('share-success-modal').remove()" style="width: 100%;">Done</button>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                const modal = document.getElementById('share-success-modal');
                if (modal) modal.remove();
            }, 5000);
        }

        function loadData() {
            const saved = localStorage.getItem('gameShelfData');
            if (saved) {
                userData = JSON.parse(saved);
                // Migrate old data
                if (!userData.reviews) userData.reviews = {};
                if (!userData.chatMessages) userData.chatMessages = [];
                if (!userData.history) userData.history = {};
                if (!userData.achievements) userData.achievements = {};
                if (!userData.dailyGoal) userData.dailyGoal = 5;
            }
        }

        let cloudSyncTimeout = null;
        
        function saveData() {
            localStorage.setItem('gameShelfData', JSON.stringify(userData));
            
            // Debounced cloud sync (wait 2 seconds after last change)
            if (currentUser && isFirebaseReady) {
                clearTimeout(cloudSyncTimeout);
                cloudSyncTimeout = setTimeout(() => {
                    saveToCloud();
                }, 2000);
            }
        }

        // ============ SETTINGS MENU ============
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const overlay = document.getElementById('settings-overlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-light').classList.add('active');
                document.getElementById('theme-dark').classList.remove('active');
            } else {
                document.body.classList.remove('light-mode');
                document.getElementById('theme-dark').classList.add('active');
                document.getElementById('theme-light').classList.remove('active');
            }
            localStorage.setItem('gameShelfTheme', theme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('gameShelfTheme') || 'dark';
            setTheme(savedTheme);
        }

        function showAbout() {
            toggleSettingsMenu();
            document.getElementById('about-modal').classList.add('active');
        }

        function closeAboutModal() {
            document.getElementById('about-modal').classList.remove('active');
        }

        // ============ EXTENSION MODAL ============
        function showExtensionModal() {
            toggleSettingsMenu();
            document.getElementById('extension-modal').classList.add('active');
            showBrowserInstructions('chrome'); // Default to Chrome
        }

        function closeExtensionModal() {
            document.getElementById('extension-modal').classList.remove('active');
        }

        function showBrowserInstructions(browser) {
            // Update tabs
            document.querySelectorAll('.ext-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all instructions
            document.querySelectorAll('.ext-instructions').forEach(inst => inst.style.display = 'none');
            
            // Show selected browser instructions
            const instructions = document.getElementById('ext-' + browser);
            if (instructions) {
                instructions.style.display = 'block';
            }
        }

        // ============ TAB NAVIGATION ============
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ============ REGISTRATION ============
        function showWelcome() {
            const list = document.getElementById('registration-list');
            list.innerHTML = POPULAR_GAMES.slice(0, 10).map(game => `
                <div class="game-list-item" onclick="toggleRegistrationGame('${game.id}')" data-id="${game.id}">
                    <span class="icon">${game.icon}</span>
                    <div class="info">
                        <div class="name">${game.name}</div>
                        <div class="source">${game.source}</div>
                    </div>
                    <div class="checkbox">âœ“</div>
                </div>
            `).join('');
            
            document.getElementById('welcome-modal').classList.add('active');
        }

        function toggleRegistrationGame(id) {
            const item = document.querySelector(`#registration-list .game-list-item[data-id="${id}"]`);
            item.classList.toggle('selected');
        }

        function completeRegistration() {
            const selected = document.querySelectorAll('#registration-list .game-list-item.selected');
            const selectedIds = Array.from(selected).map(el => el.dataset.id);
            
            selectedIds.forEach(id => {
                const game = POPULAR_GAMES.find(g => g.id === id);
                if (game && !userData.games.find(g => g.id === id)) {
                    userData.games.push({ ...game });
                    userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
            });
            
            userData.registered = true;
            saveData();
            
            document.getElementById('welcome-modal').classList.remove('active');
            renderMyGames();
            renderDiscoverList();
            updateStats();
        }

        function skipRegistration() {
            userData.registered = true;
            saveData();
            document.getElementById('welcome-modal').classList.remove('active');
        }

        // ============ RENDERING ============
        function renderFeaturedGames() {
            const container = document.getElementById('featured-games');
            container.innerHTML = FEATURED_GAMES.map(game => {
                const stats = userData.stats[game.id] || { lastPlayed: null, streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                const review = userData.reviews[game.id];
                
                return `
                    <div class="featured-card ${playedToday ? 'played-today' : ''}" onclick="playGame('${game.id}', '${game.url}', true)">
                        <span class="featured-badge">RB Games</span>
                        ${playedToday ? '<span class="check-badge">âœ“</span>' : ''}
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        <div class="streak ${stats.streak > 0 ? 'active' : ''}">
                            ${stats.streak > 0 ? 'ðŸ”¥ ' + stats.streak + ' day streak' : 'Start your streak!'}
                        </div>
                        ${review && review.rating ? `<div class="rating">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5-review.rating)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderMyGames() {
            const container = document.getElementById('my-games');
            
            if (userData.games.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">ðŸ“š</div>
                        <p>No games added yet.<br>Click "Add Game" to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = userData.games.map(game => {
                const stats = userData.stats[game.id] || { lastPlayed: null, streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                const review = userData.reviews[game.id];
                
                return `
                    <div class="game-card ${playedToday ? 'played-today' : ''}" onclick="playGame('${game.id}', '${game.url}')">
                        <button class="remove-btn" onclick="event.stopPropagation(); removeGame('${game.id}')">âœ•</button>
                        ${playedToday ? '<span class="check-badge">âœ“</span>' : ''}
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        <div class="streak ${stats.streak > 0 ? 'active' : ''}">
                            ${stats.streak > 0 ? 'ðŸ”¥ ' + stats.streak : 'No streak'}
                        </div>
                        ${review && review.rating ? `<div class="rating">${'<span class="star filled">â˜…</span>'.repeat(review.rating)}${'<span class="star">â˜…</span>'.repeat(5-review.rating)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderDiscoverList() {
            const existingIds = [...userData.games.map(g => g.id), ...FEATURED_GAMES.map(g => g.id)];
            const available = POPULAR_GAMES.filter(g => !existingIds.includes(g.id));
            
            const container = document.getElementById('discover-list');
            
            if (available.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">ðŸŽ‰</div>
                        <p>You've added all the games!<br>Check the Community tab for more.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = available.map(game => `
                <div class="discover-card" onclick="addGameFromDiscover('${game.id}')">
                    <div class="header">
                        <span class="icon">${game.icon}</span>
                        <div>
                            <div class="name">${game.name}</div>
                            <div class="source">${game.source}</div>
                        </div>
                    </div>
                    <div class="description">${game.description}</div>
                    <div class="tags">
                        ${game.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderReviews() {
            const allGames = [...FEATURED_GAMES, ...userData.games];
            const gamesWithStats = allGames.filter(g => userData.stats[g.id] && userData.stats[g.id].totalPlays > 0);
            
            const container = document.getElementById('reviews-list');
            const emptyState = document.getElementById('reviews-empty');
            
            if (gamesWithStats.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = gamesWithStats.map(game => {
                const stats = userData.stats[game.id] || {};
                const review = userData.reviews[game.id] || {};
                
                return `
                    <div class="review-card">
                        <div class="review-header">
                            <span class="icon">${game.icon}</span>
                            <div class="info">
                                <h4>${game.name}</h4>
                                <div class="stars">${review.rating ? 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5-review.rating) : '<span style="color: var(--text-muted)">Not rated</span>'}</div>
                            </div>
                            <div style="margin-left: auto; text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                                <div>ðŸ”¥ ${stats.streak || 0} streak</div>
                                <div>ðŸ“Š ${stats.totalPlays || 0} plays</div>
                            </div>
                        </div>
                        <div class="review-notes" onclick="openReviewModal('${game.id}')">${review.notes || ''}</div>
                        <div class="review-actions">
                            <button class="btn btn-secondary btn-small" onclick="openReviewModal('${game.id}')">âœï¸ ${review.rating ? 'Edit' : 'Add'} Review</button>
                            <button class="btn btn-secondary btn-small" onclick="playGame('${game.id}', '${game.url}', ${game.featured || false})">â–¶ï¸ Play</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ GAME ACTIONS ============
        // Track last played game for return detection
        let lastPlayedGame = null;
        let lastPlayedTime = null;

        function playGame(id, url, featured = false, gameName = '') {
            // Track for return detection
            const game = FEATURED_GAMES.find(g => g.id === id) || 
                         POPULAR_GAMES.find(g => g.id === id) || 
                         userData.games.find(g => g.id === id);
            lastPlayedGame = {
                id: id,
                name: gameName || game?.name || id,
                icon: game?.icon || 'ðŸŽ®',
                url: url
            };
            lastPlayedTime = Date.now();
            
            // Open game in new tab FIRST (before any potential errors)
            window.open(url, '_blank');
            
            // Initialize stats if needed
            if (!userData.stats[id]) {
                userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
            }
            
            const stats = userData.stats[id];
            const today = getTodayString();
            const yesterday = getYesterdayString();
            
            // Update streak logic
            if (stats.lastPlayed !== today) {
                if (stats.lastPlayed === yesterday) {
                    stats.streak++;
                } else if (stats.lastPlayed !== today) {
                    stats.streak = 1;
                }
                stats.totalPlays++;
                stats.lastPlayed = today;
                
                // Track total completed
                if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                userData.stats.totalCompleted++;
                
                // Publish activity to friends (wrapped in try-catch)
                try {
                    publishActivity(id, gameName || id);
                } catch (e) {
                    console.error('Failed to publish activity:', e);
                }
            }
            
            saveData();
            recordHistory();
            
            // Re-render and update
            try {
                renderFeaturedGames();
                renderMyGames();
                renderReviews();
                updateStats();
                renderCalendar();
                updateDailyGoal();
                renderInsights();
                renderLeaderboard();
                
                // Check achievements
                checkAndUnlockAchievements();
                unlockTimeAchievement();
            } catch (e) {
                console.error('Failed to update UI:', e);
            }
        }

        function removeGame(id) {
            if (!confirm('Remove this game from your shelf?')) return;
            
            userData.games = userData.games.filter(g => g.id !== id);
            delete userData.stats[id];
            delete userData.reviews[id];
            saveData();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            updateStats();
        }

        function addGameFromDiscover(id) {
            const game = POPULAR_GAMES.find(g => g.id === id);
            if (game && !userData.games.find(g => g.id === id)) {
                userData.games.push({ ...game });
                userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                saveData();
                renderMyGames();
                renderDiscoverList();
                updateStats();
                
                // Show confirmation
                alert(`${game.icon} ${game.name} added to your shelf!`);
            }
        }

        // ============ ADD GAME ============
        function showAddGameModal() {
            const existingIds = [...userData.games.map(g => g.id), ...FEATURED_GAMES.map(g => g.id)];
            const available = POPULAR_GAMES.filter(g => !existingIds.includes(g.id));
            
            const list = document.getElementById('add-game-list');
            
            if (available.length > 0) {
                list.innerHTML = available.map(game => `
                    <div class="game-list-item" onclick="toggleAddGame('${game.id}')" data-id="${game.id}">
                        <span class="icon">${game.icon}</span>
                        <div class="info">
                            <div class="name">${game.name}</div>
                            <div class="source">${game.source}</div>
                        </div>
                        <div class="checkbox">âœ“</div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p style="text-align:center; color: var(--text-muted);">All popular games added! Use the form below to add custom games.</p>';
            }
            
            // Clear custom inputs
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-url').value = '';
            document.getElementById('custom-icon').value = '';
            
            document.getElementById('add-game-modal').classList.add('active');
        }

        function closeAddGameModal() {
            document.getElementById('add-game-modal').classList.remove('active');
        }

        // Auto-detect game info from URL
        const URL_PATTERNS = {
            'nytimes.com/games/wordle': { name: 'Wordle', icon: 'ðŸŸ©' },
            'nytimes.com/games/connections': { name: 'Connections', icon: 'ðŸ”—' },
            'nytimes.com/games/strands': { name: 'Strands', icon: 'ðŸ§µ' },
            'nytimes.com/puzzles/spelling-bee': { name: 'Spelling Bee', icon: 'ðŸ' },
            'nytimes.com/crosswords/game/mini': { name: 'Mini Crossword', icon: 'ðŸ“' },
            'nytimes.com/puzzles/letter-boxed': { name: 'Letter Boxed', icon: 'ðŸ“¦' },
            'worldle.teuteuf.fr': { name: 'Worldle', icon: 'ðŸŒ' },
            'globle-game.com': { name: 'Globle', icon: 'ðŸŒŽ' },
            'quordle': { name: 'Quordle', icon: '4ï¸âƒ£' },
            'octordle': { name: 'Octordle', icon: '8ï¸âƒ£' },
            'semantle': { name: 'Semantle', icon: 'ðŸ§ ' },
            'redactle': { name: 'Redactle', icon: 'â–ˆ' },
            'immaculategrid': { name: 'Immaculate Grid', icon: 'âš¾' },
            'costcodle': { name: 'Costcodle', icon: 'ðŸ›’' },
            'tradle': { name: 'Tradle', icon: 'ðŸš¢' },
            'foodguessr': { name: 'FoodGuessr', icon: 'ðŸ”' },
            'framed.wtf': { name: 'Framed', icon: 'ðŸŽ¬' },
            'nerdle': { name: 'Nerdle', icon: 'ðŸ§®' },
        };

        function autoDetectGameInfo() {
            const urlInput = document.getElementById('custom-url');
            const nameInput = document.getElementById('custom-name');
            const iconInput = document.getElementById('custom-icon');
            
            const url = urlInput.value.toLowerCase();
            
            // Try to match known patterns
            for (const [pattern, info] of Object.entries(URL_PATTERNS)) {
                if (url.includes(pattern)) {
                    if (!nameInput.value) nameInput.value = info.name;
                    if (!iconInput.value) iconInput.value = info.icon;
                    return;
                }
            }
            
            // Try to extract game name from URL
            if (!nameInput.value && url) {
                try {
                    const urlObj = new URL(url.startsWith('http') ? url : 'https://' + url);
                    let name = urlObj.hostname.replace('www.', '').split('.')[0];
                    name = name.charAt(0).toUpperCase() + name.slice(1);
                    nameInput.value = name;
                } catch (e) {
                    // Invalid URL, ignore
                }
            }
        }

        function toggleAddGame(id) {
            const item = document.querySelector(`#add-game-list .game-list-item[data-id="${id}"]`);
            item.classList.toggle('selected');
        }

        function addSelectedGames() {
            // Add selected popular games
            const selected = document.querySelectorAll('#add-game-list .game-list-item.selected');
            const selectedIds = Array.from(selected).map(el => el.dataset.id);
            
            selectedIds.forEach(id => {
                const game = POPULAR_GAMES.find(g => g.id === id);
                if (game && !userData.games.find(g => g.id === id)) {
                    userData.games.push({ ...game });
                    userData.stats[id] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                }
            });
            
            // Add custom game if filled in
            const customName = document.getElementById('custom-name').value.trim();
            const customUrl = document.getElementById('custom-url').value.trim();
            const customIcon = document.getElementById('custom-icon').value.trim() || 'ðŸŽ®';
            
            if (customName && customUrl) {
                const customId = 'custom-' + Date.now();
                userData.games.push({
                    id: customId,
                    name: customName,
                    url: customUrl,
                    icon: customIcon,
                    source: 'Custom',
                    description: 'Custom game',
                    tags: ['custom']
                });
                userData.stats[customId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
            }
            
            saveData();
            closeAddGameModal();
            renderMyGames();
            renderDiscoverList();
            updateStats();
        }

        // ============ REVIEWS ============
        function setupStarRating() {
            const stars = document.querySelectorAll('#rating-input .star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.value);
                    updateStarDisplay();
                });
                star.addEventListener('mouseenter', () => {
                    highlightStars(parseInt(star.dataset.value));
                });
            });
            
            document.getElementById('rating-input').addEventListener('mouseleave', () => {
                updateStarDisplay();
            });
        }

        function highlightStars(count) {
            const stars = document.querySelectorAll('#rating-input .star');
            stars.forEach((star, i) => {
                star.classList.toggle('filled', i < count);
            });
        }

        function updateStarDisplay() {
            highlightStars(currentRating);
        }

        function openReviewModal(gameId) {
            currentReviewGameId = gameId;
            
            const game = [...FEATURED_GAMES, ...userData.games].find(g => g.id === gameId);
            const review = userData.reviews[gameId] || {};
            
            document.getElementById('review-game-icon').textContent = game.icon;
            document.getElementById('review-game-name').textContent = game.name;
            document.getElementById('review-notes').value = review.notes || '';
            
            currentRating = review.rating || 0;
            updateStarDisplay();
            
            document.getElementById('review-modal').classList.add('active');
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.remove('active');
            currentReviewGameId = null;
            currentRating = 0;
        }

        function saveReview() {
            if (!currentReviewGameId) return;
            
            userData.reviews[currentReviewGameId] = {
                rating: currentRating,
                notes: document.getElementById('review-notes').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            saveData();
            closeReviewModal();
            renderFeaturedGames();
            renderMyGames();
            renderReviews();
        }

        // ============ SETTINGS ============
        function resetAllData() {
            if (!confirm('This will delete all your games and stats. Are you sure?')) return;
            
            localStorage.removeItem('gameShelfData');
            localStorage.removeItem('gameShelfTheme');
            userData = { registered: false, games: [], stats: {}, reviews: {}, chatMessages: [], history: {}, achievements: {}, dailyGoal: 5 };
            
            toggleSettingsMenu();
            renderFeaturedGames();
            renderMyGames();
            renderDiscoverList();
            renderReviews();
            renderChat();
            updateStats();
            renderCalendar();
            renderAchievements();
            updateDailyGoal();
            renderInsights();
            showWelcome();
        }

        function exportData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gameshelf-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('ðŸ“¤ Data exported!');
        }

        // ============ CALENDAR HEATMAP ============
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-label');
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            monthLabel.textContent = `${months[calendarMonth]} ${calendarYear}`;
            
            // Clear existing days (keep labels)
            const existingDays = grid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());
            
            // Get first day of month and total days
            const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
            const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
            const today = new Date();
            const todayStr = getTodayString();
            
            // Add empty cells for days before first of month
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }
            
            // Add days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = getHistoryForDate(dateStr);
                const level = getActivityLevel(dayData);
                const isToday = dateStr === todayStr;
                
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day level-${level}${isToday ? ' today' : ''}`;
                dayEl.textContent = day;
                
                // Tooltip
                if (dayData.gamesPlayed > 0) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'calendar-tooltip';
                    tooltip.textContent = `${dayData.gamesPlayed}/${dayData.totalGames} games`;
                    dayEl.appendChild(tooltip);
                }
                
                grid.appendChild(dayEl);
            }
        }

        function getHistoryForDate(dateStr) {
            // Check if we have history data
            if (userData.history && userData.history[dateStr]) {
                return userData.history[dateStr];
            }
            
            // Fallback: calculate from stats
            const allStats = { ...userData.stats };
            let gamesPlayed = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === dateStr) gamesPlayed++;
            });
            
            return {
                gamesPlayed,
                totalGames: FEATURED_GAMES.length + userData.games.length
            };
        }

        function getActivityLevel(dayData) {
            if (!dayData || dayData.gamesPlayed === 0) return 0;
            const ratio = dayData.gamesPlayed / Math.max(dayData.totalGames, 1);
            if (ratio >= 0.9) return 4;
            if (ratio >= 0.6) return 3;
            if (ratio >= 0.3) return 2;
            return 1;
        }

        function prevMonth() {
            calendarMonth--;
            if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            const now = new Date();
            const targetDate = new Date(calendarYear, calendarMonth + 1, 1);
            if (targetDate <= now) {
                calendarMonth++;
                if (calendarMonth > 11) {
                    calendarMonth = 0;
                    calendarYear++;
                }
                renderCalendar();
            }
        }

        function recordHistory() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            let gamesPlayed = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) gamesPlayed++;
            });
            
            userData.history[today] = {
                gamesPlayed,
                totalGames: FEATURED_GAMES.length + userData.games.length
            };
            
            saveData();
        }

        // ============ ACHIEVEMENTS ============
        function getMaxStreak(data) {
            let maxStreak = 0;
            Object.values(data.stats || {}).forEach(stat => {
                if (stat.streak > maxStreak) maxStreak = stat.streak;
            });
            return maxStreak;
        }

        function hasPerfectDay(data) {
            const history = data.history || {};
            for (const day of Object.values(history)) {
                if (day.gamesPlayed > 0 && day.gamesPlayed >= day.totalGames) {
                    return true;
                }
            }
            return false;
        }

        function checkTimeAchievements() {
            const hour = new Date().getHours();
            if (hour < 7 && !userData.achievements['early-bird']) {
                // Will be unlocked when they play a game
            }
            if (hour >= 23 && !userData.achievements['night-owl']) {
                // Will be unlocked when they play a game
            }
        }

        function unlockTimeAchievement() {
            const hour = new Date().getHours();
            if (hour < 7 && !userData.achievements['early-bird']) {
                userData.achievements['early-bird'] = getTodayString();
                showToast('ðŸ† Achievement Unlocked: Early Bird!');
            }
            if (hour >= 23 && !userData.achievements['night-owl']) {
                userData.achievements['night-owl'] = getTodayString();
                showToast('ðŸ† Achievement Unlocked: Night Owl!');
            }
        }

        function checkAndUnlockAchievements() {
            let newUnlocks = [];
            
            ACHIEVEMENTS.forEach(achievement => {
                if (!userData.achievements[achievement.id] && achievement.check(userData)) {
                    userData.achievements[achievement.id] = getTodayString();
                    newUnlocks.push(achievement);
                }
            });
            
            if (newUnlocks.length > 0) {
                saveData();
                renderAchievements();
                newUnlocks.forEach(a => {
                    setTimeout(() => showToast(`ðŸ† ${a.icon} ${a.name} unlocked!`), 500);
                });
            }
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            const progressFill = document.getElementById('achievements-progress-fill');
            const progressText = document.getElementById('achievements-progress-text');
            
            let unlockedCount = 0;
            
            grid.innerHTML = ACHIEVEMENTS.map(achievement => {
                const isUnlocked = userData.achievements && userData.achievements[achievement.id];
                if (isUnlocked) unlockedCount++;
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <span class="achievement-icon">${achievement.icon}</span>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${isUnlocked ? 'âœ“ Unlocked' : achievement.desc}</div>
                    </div>
                `;
            }).join('');
            
            const percentage = (unlockedCount / ACHIEVEMENTS.length) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `${unlockedCount}/${ACHIEVEMENTS.length}`;
        }

        // ============ DAILY GOAL ============
        function updateDailyGoal() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            let playedToday = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
            });
            
            const goal = userData.dailyGoal || 5;
            const progress = Math.min(playedToday / goal, 1);
            const circumference = 2 * Math.PI * 25; // radius 25 for smaller ring
            const offset = circumference - (progress * circumference);
            
            // Update ring
            const circle = document.getElementById('goal-progress-circle');
            if (circle) {
                circle.setAttribute('stroke-dasharray', circumference);
                circle.setAttribute('stroke-dashoffset', offset);
                if (playedToday >= goal) {
                    circle.setAttribute('stroke', 'var(--accent-green)');
                } else {
                    circle.setAttribute('stroke', 'var(--accent-gold)');
                }
            }
            
            // Update numbers
            const currentEl = document.getElementById('goal-current');
            const targetEl = document.getElementById('goal-target');
            if (currentEl) currentEl.textContent = playedToday;
            if (targetEl) targetEl.textContent = goal;
        }

        // ============ COLLAPSIBLE SECTIONS ============
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (chevron) {
                    chevron.textContent = 'â–¼';
                    chevron.classList.add('open');
                }
            } else {
                content.style.display = 'none';
                if (chevron) {
                    chevron.textContent = 'â–¶';
                    chevron.classList.remove('open');
                }
            }
        }

        function toggleQuickLog() {
            document.getElementById('quick-log-modal').classList.add('active');
        }

        function closeQuickLogModal() {
            document.getElementById('quick-log-modal').classList.remove('active');
            document.getElementById('parse-result').style.display = 'none';
        }

        function showGoalModal() {
            const goal = userData.dailyGoal || 5;
            document.querySelectorAll('.goal-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.goal) === goal);
            });
            document.getElementById('custom-goal').value = '';
            document.getElementById('goal-modal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        function selectGoal(value) {
            document.querySelectorAll('.goal-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.goal) === value);
            });
            document.getElementById('custom-goal').value = '';
        }

        function saveGoal() {
            const customGoal = document.getElementById('custom-goal').value;
            let goal;
            
            if (customGoal && parseInt(customGoal) > 0) {
                goal = Math.min(parseInt(customGoal), 20);
            } else {
                const selected = document.querySelector('.goal-option.selected');
                goal = selected ? parseInt(selected.dataset.goal) : 5;
            }
            
            userData.dailyGoal = goal;
            saveData();
            closeGoalModal();
            updateDailyGoal();
            showToast(`ðŸŽ¯ Daily goal set to ${goal} games!`);
        }

        // ============ INSIGHTS ============
        function setInsightsPeriod(period) {
            insightsPeriod = period;
            document.querySelectorAll('.insights-period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(period));
            });
            renderInsights();
        }

        function renderInsights() {
            const stats = calculatePeriodStats(insightsPeriod);
            
            // Update stat cards
            document.getElementById('insight-games-played').textContent = stats.gamesPlayed;
            document.getElementById('insight-completion').textContent = stats.completionRate + '%';
            document.getElementById('insight-current-streak').textContent = stats.currentStreak;
            document.getElementById('insight-best-streak').textContent = stats.bestStreak;
            
            // Change indicators
            const gamesChange = document.getElementById('insight-games-change');
            const completionChange = document.getElementById('insight-completion-change');
            
            if (stats.gamesChange !== 0) {
                gamesChange.textContent = (stats.gamesChange > 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(stats.gamesChange) + ' vs last ' + insightsPeriod;
                gamesChange.className = 'insight-change ' + (stats.gamesChange > 0 ? 'positive' : 'negative');
            } else {
                gamesChange.textContent = 'â€” same as last ' + insightsPeriod;
                gamesChange.className = 'insight-change';
            }
            
            // Best days grid
            renderBestDays(stats.dayBreakdown);
            
            // Game rankings
            renderGameRankings();
            
            // Cross-game insights
            renderCrossInsights();
            
            // Annual wrapped
            renderWrapped();
        }

        function calculatePeriodStats(period) {
            const today = new Date();
            let days = 7;
            if (period === 'month') days = 30;
            if (period === 'year') days = 365;
            
            let gamesPlayed = 0;
            let possibleGames = 0;
            let currentStreak = 0;
            let bestStreak = 0;
            let dayBreakdown = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
            let dayCount = [0, 0, 0, 0, 0, 0, 0];
            
            // Calculate current and previous period
            let prevGamesPlayed = 0;
            
            for (let i = 0; i < days * 2; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                
                const dayData = userData.history[dateStr];
                const played = dayData ? dayData.gamesPlayed : 0;
                const total = dayData ? dayData.totalGames : (FEATURED_GAMES.length + userData.games.length);
                
                if (i < days) {
                    gamesPlayed += played;
                    possibleGames += total;
                    dayBreakdown[dayOfWeek] += played;
                    dayCount[dayOfWeek]++;
                } else {
                    prevGamesPlayed += played;
                }
            }
            
            // Average by day count
            for (let i = 0; i < 7; i++) {
                if (dayCount[i] > 0) {
                    dayBreakdown[i] = Math.round(dayBreakdown[i] / dayCount[i] * 10) / 10;
                }
            }
            
            // Get streaks from stats
            Object.values(userData.stats || {}).forEach(stat => {
                if (stat.streak > currentStreak) currentStreak = stat.streak;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const completionRate = possibleGames > 0 ? Math.round((gamesPlayed / possibleGames) * 100) : 0;
            
            return {
                gamesPlayed,
                completionRate,
                currentStreak,
                bestStreak,
                gamesChange: gamesPlayed - prevGamesPlayed,
                dayBreakdown
            };
        }

        function renderBestDays(breakdown) {
            const grid = document.getElementById('best-days-grid');
            if (!grid) return;
            
            const max = Math.max(...breakdown, 1);
            
            grid.innerHTML = breakdown.map((val, i) => {
                const intensity = val / max;
                const isActive = intensity > 0.5;
                return `<div class="best-time-cell ${isActive ? 'active' : ''}" 
                    style="opacity: ${0.3 + intensity * 0.7}"
                    title="${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i]}: ${val} avg games">${val > 0 ? val.toFixed(1) : ''}</div>`;
            }).join('');
        }

        function renderGameRankings() {
            const container = document.getElementById('game-rankings');
            if (!container) return;
            
            const allGames = [...FEATURED_GAMES, ...userData.games];
            const rankings = allGames.map(game => {
                const stats = userData.stats[game.id] || { totalPlays: 0, streak: 0 };
                return { ...game, totalPlays: stats.totalPlays || 0, streak: stats.streak || 0 };
            }).sort((a, b) => b.totalPlays - a.totalPlays).slice(0, 5);
            
            if (rankings.length === 0 || rankings[0].totalPlays === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Play some games to see your rankings!</div>';
                return;
            }
            
            container.innerHTML = rankings.map((game, i) => `
                <div class="game-ranking-item">
                    <div class="game-ranking-position">${i + 1}</div>
                    <span class="game-ranking-icon">${game.icon}</span>
                    <div class="game-ranking-info">
                        <div class="game-ranking-name">${game.name}</div>
                        <div class="game-ranking-stats">${game.totalPlays} plays â€¢ <span class="game-ranking-streak">${game.streak}ðŸ”¥</span></div>
                    </div>
                </div>
            `).join('');
        }

        function renderCrossInsights() {
            const container = document.getElementById('cross-insights-list');
            if (!container) return;
            
            const insights = generateCrossInsights();
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="cross-insight-item"><div class="cross-insight-icon">ðŸ“Š</div><div class="cross-insight-text"><div class="cross-insight-title">Keep playing!</div><div class="cross-insight-desc">We\'ll show you patterns and insights after a few days of activity.</div></div></div>';
                return;
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="cross-insight-item">
                    <div class="cross-insight-icon">${insight.icon}</div>
                    <div class="cross-insight-text">
                        <div class="cross-insight-title">${insight.title}</div>
                        <div class="cross-insight-desc">${insight.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        function generateCrossInsights() {
            const insights = [];
            const history = userData.history || {};
            const historyDays = Object.keys(history);
            
            if (historyDays.length < 3) return insights;
            
            // Find best day of week
            const dayTotals = [0,0,0,0,0,0,0];
            const dayCounts = [0,0,0,0,0,0,0];
            
            historyDays.forEach(dateStr => {
                const day = new Date(dateStr).getDay();
                dayTotals[day] += history[dateStr].gamesPlayed || 0;
                dayCounts[day]++;
            });
            
            const dayAvgs = dayTotals.map((t, i) => dayCounts[i] > 0 ? t / dayCounts[i] : 0);
            const bestDayIndex = dayAvgs.indexOf(Math.max(...dayAvgs));
            const worstDayIndex = dayAvgs.indexOf(Math.min(...dayAvgs.filter(d => d > 0)));
            const dayNames = ['Sundays', 'Mondays', 'Tuesdays', 'Wednesdays', 'Thursdays', 'Fridays', 'Saturdays'];
            
            if (dayAvgs[bestDayIndex] > 0) {
                insights.push({
                    icon: 'ðŸ“…',
                    title: `${dayNames[bestDayIndex]} are your best days`,
                    desc: `You play ${dayAvgs[bestDayIndex].toFixed(1)} games on average`
                });
            }
            
            // Most consistent game
            const allGames = [...FEATURED_GAMES, ...userData.games];
            let mostConsistent = null;
            let highestStreak = 0;
            
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.streak > highestStreak) {
                    highestStreak = stats.streak;
                    mostConsistent = game;
                }
            });
            
            if (mostConsistent && highestStreak > 2) {
                insights.push({
                    icon: mostConsistent.icon,
                    title: `${mostConsistent.name} is your most consistent`,
                    desc: `You've played it ${highestStreak} days in a row!`
                });
            }
            
            // Goal achievement rate
            const goalDays = historyDays.filter(d => {
                const data = history[d];
                return data.gamesPlayed >= (userData.dailyGoal || 5);
            }).length;
            
            if (historyDays.length >= 7) {
                const goalRate = Math.round((goalDays / historyDays.length) * 100);
                insights.push({
                    icon: 'ðŸŽ¯',
                    title: `${goalRate}% goal hit rate`,
                    desc: `You've hit your daily goal ${goalDays} out of ${historyDays.length} days`
                });
            }
            
            // Total games milestone
            const totalCompleted = userData.stats.totalCompleted || 0;
            if (totalCompleted >= 50) {
                insights.push({
                    icon: 'ðŸ†',
                    title: `${totalCompleted} games completed!`,
                    desc: 'You\'re becoming a daily puzzle master'
                });
            }
            
            return insights.slice(0, 4);
        }

        // ============ ANNUAL WRAPPED ============
        function renderWrapped() {
            const history = userData.history || {};
            const allGames = [...FEATURED_GAMES, ...userData.games];
            
            // Calculate year stats
            let totalGames = 0;
            let daysActive = 0;
            let bestStreak = 0;
            const gamePlayCounts = {};
            
            Object.values(history).forEach(day => {
                totalGames += day.gamesPlayed || 0;
                if (day.gamesPlayed > 0) daysActive++;
            });
            
            // Get unique games played
            allGames.forEach(game => {
                const stats = userData.stats[game.id];
                if (stats && stats.totalPlays > 0) {
                    gamePlayCounts[game.id] = stats.totalPlays;
                }
                if (stats && stats.streak > bestStreak) bestStreak = stats.streak;
            });
            
            const uniqueGames = Object.keys(gamePlayCounts).length;
            
            // Find top game
            let topGame = null;
            let topPlays = 0;
            allGames.forEach(game => {
                const plays = gamePlayCounts[game.id] || 0;
                if (plays > topPlays) {
                    topPlays = plays;
                    topGame = game;
                }
            });
            
            // Update wrapped UI
            document.getElementById('wrapped-total-games').textContent = totalGames;
            document.getElementById('wrapped-total-days').textContent = daysActive;
            document.getElementById('wrapped-best-streak').textContent = bestStreak;
            document.getElementById('wrapped-unique-games').textContent = uniqueGames;
            
            const topGameEl = document.getElementById('wrapped-top-game');
            if (topGame) {
                topGameEl.innerHTML = `<span>${topGame.icon}</span> <span>${topGame.name}</span>`;
            } else {
                topGameEl.innerHTML = `<span>ðŸŽ®</span> <span>Play more to find out!</span>`;
            }
        }

        function shareWrapped() {
            const totalGames = document.getElementById('wrapped-total-games').textContent;
            const daysActive = document.getElementById('wrapped-total-days').textContent;
            const bestStreak = document.getElementById('wrapped-best-streak').textContent;
            
            const text = `ðŸŽ® My Game Shelf Wrapped 2025

ðŸ“Š ${totalGames} games played
ðŸ“… ${daysActive} days active  
ðŸ”¥ ${bestStreak} best streak

What's your stats? gameshelf.app`;
            
            if (navigator.share) {
                navigator.share({ text }).then(() => {
                    if (!userData.achievements['social']) {
                        userData.achievements['social'] = getTodayString();
                        saveData();
                        checkAndUnlockAchievements();
                    }
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(text);
                showToast('ðŸ“‹ Wrapped copied to clipboard!');
            }
        }

        // ============ SHARE LINK ============
        function generateShareLink() {
            // Generate a simple hash from user data
            const games = [...FEATURED_GAMES.map(g => g.id), ...userData.games.map(g => g.id)];
            const hash = btoa(JSON.stringify({ g: games.slice(0, 10), n: userData.registered ? 'Player' : 'Guest' })).slice(0, 20);
            
            const linkEl = document.getElementById('share-link-url');
            if (linkEl) {
                linkEl.value = `gameshelf.app/s/${hash}`;
            }
        }

        function copyShareLink() {
            const link = document.getElementById('share-link-url').value;
            navigator.clipboard.writeText('https://' + link);
            showToast('ðŸ”— Link copied!');
            
            if (!userData.achievements['social']) {
                userData.achievements['social'] = getTodayString();
                saveData();
                checkAndUnlockAchievements();
            }
        }

        // ============ SHARE TEXT PARSING ============
        const GAME_PATTERNS = [
            {
                id: 'wordle',
                name: 'Wordle',
                icon: 'ðŸŸ©',
                pattern: /Wordle\s+[\d,]+\s+(\d|X)\/6/i,
                extract: (match) => {
                    const score = match[0].match(/(\d|X)\/6/)[1];
                    return { score: score === 'X' ? 'X/6' : `${score}/6`, success: score !== 'X' };
                }
            },
            {
                id: 'connections',
                name: 'Connections',
                icon: 'ðŸ”—',
                pattern: /Connections\s*\n?Puzzle\s*#?\d+/i,
                extract: (match, text) => {
                    const lines = text.split('\n').filter(l => /^[ðŸŸ¨ðŸŸ©ðŸŸ¦ðŸŸª]+$/.test(l.trim()));
                    const mistakes = lines.length - 4;
                    return { score: `${Math.max(0, 4 - mistakes)} mistakes`, success: mistakes <= 4 };
                }
            },
            {
                id: 'strands',
                name: 'Strands',
                icon: 'ðŸ§µ',
                pattern: /Strands\s*#?\d+/i,
                extract: (match, text) => {
                    const hints = (text.match(/ðŸ’¡/g) || []).length;
                    return { score: hints > 0 ? `${hints} hints` : 'No hints!', success: true };
                }
            },
            {
                id: 'spelling-bee',
                name: 'Spelling Bee',
                icon: 'ðŸ',
                pattern: /Spelling\s*Bee|ðŸ.*Genius|ðŸ.*Queen/i,
                extract: (match, text) => {
                    if (text.includes('Queen')) return { score: 'Queen Bee! ðŸ‘‘', success: true };
                    if (text.includes('Genius')) return { score: 'Genius!', success: true };
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'mini',
                name: 'Mini Crossword',
                icon: 'ðŸ“',
                pattern: /Mini\s*Crossword|I\s+solved.*NYT\s+Mini/i,
                extract: (match, text) => {
                    const timeMatch = text.match(/(\d+):(\d+)/);
                    if (timeMatch) {
                        return { score: `${timeMatch[1]}:${timeMatch[2]}`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'letterboxed',
                name: 'Letterboxed',
                icon: 'ðŸ“¦',
                pattern: /Letter\s*Boxed|I\s+solved.*Letter.*in\s+\d+/i,
                extract: (match, text) => {
                    const wordMatch = text.match(/in\s+(\d+)\s+word/i);
                    if (wordMatch) {
                        return { score: `${wordMatch[1]} words`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'quordle',
                name: 'Quordle',
                icon: '4ï¸âƒ£',
                pattern: /Daily\s+Quordle\s+\d+/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'octordle',
                name: 'Octordle',
                icon: '8ï¸âƒ£',
                pattern: /Daily\s+Octordle\s+#?\d+/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'worldle',
                name: 'Worldle',
                icon: 'ðŸŒ',
                pattern: /#Worldle\s+#?\d+/i,
                extract: (match, text) => {
                    const guesses = (text.match(/[ðŸŸ©ðŸŸ¨â¬›ðŸŸ§â¬œ]/g) || []).length / 5;
                    return { score: `${Math.ceil(guesses)}/6 guesses`, success: true };
                }
            },
            {
                id: 'globle',
                name: 'Globle',
                icon: 'ðŸŒŽ',
                pattern: /ðŸŒŽ\s*\w+\s+\d+,\s+\d+\s+ðŸŒ|Globle/i,
                extract: () => ({ score: 'Completed', success: true })
            },
            {
                id: 'tradle',
                name: 'Tradle',
                icon: 'ðŸš¢',
                pattern: /#Tradle\s+#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'framed',
                name: 'Framed',
                icon: 'ðŸŽ¬',
                pattern: /Framed\s+#?\d+/i,
                extract: (match, text) => {
                    const frames = (text.match(/ðŸŽ¥|ðŸŸ©|ðŸŸ¥/g) || []).length;
                    return { score: `${frames}/6 frames`, success: text.includes('ðŸŸ©') };
                }
            },
            {
                id: 'nerdle',
                name: 'Nerdle',
                icon: 'ðŸ§®',
                pattern: /nerdlegame\s+\d+|Nerdle\s+\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'redactle',
                name: 'Redactle',
                icon: 'â–ˆ',
                pattern: /Redactle\s+#?\d+|I\s+solved\s+Redactle/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]} guesses`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'semantle',
                name: 'Semantle',
                icon: 'ðŸ§ ',
                pattern: /Semantle\s+#?\d+|I\s+solved\s+Semantle/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\s+guesses/i);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]} guesses`, success: true };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'immaculate-grid',
                name: 'Immaculate Grid',
                icon: 'âš¾',
                pattern: /Immaculate\s+Grid|âš¾.*\/9/i,
                extract: (match, text) => {
                    const scoreMatch = text.match(/(\d+)\/9/);
                    if (scoreMatch) {
                        return { score: `${scoreMatch[1]}/9`, success: parseInt(scoreMatch[1]) >= 5 };
                    }
                    return { score: 'Completed', success: true };
                }
            },
            {
                id: 'costcodle',
                name: 'Costcodle',
                icon: 'ðŸ›’',
                pattern: /Costcodle\s+#?\d+/i,
                extract: (match, text) => {
                    const guessMatch = text.match(/(\d+)\/6/);
                    if (guessMatch) {
                        return { score: `${guessMatch[1]}/6`, success: guessMatch[1] !== 'X' };
                    }
                    return { score: 'Completed', success: true };
                }
            }
        ];

        function parseShareText() {
            const input = document.getElementById('parse-input');
            const result = document.getElementById('parse-result');
            const resultIcon = document.getElementById('parse-result-icon');
            const resultGame = document.getElementById('parse-result-game');
            const resultScore = document.getElementById('parse-result-score');
            
            const text = input.value.trim();
            
            if (!text) {
                showToast('Please paste your game results');
                return;
            }
            
            let matched = false;
            
            for (const game of GAME_PATTERNS) {
                const match = text.match(game.pattern);
                if (match) {
                    const extracted = game.extract(match, text);
                    
                    // Mark the game as played
                    const gameId = game.id;
                    const today = getTodayString();
                    
                    if (!userData.stats[gameId]) {
                        userData.stats[gameId] = { lastPlayed: null, streak: 0, totalPlays: 0 };
                    }
                    
                    if (userData.stats[gameId].lastPlayed !== today) {
                        const yesterday = getYesterdayString();
                        if (userData.stats[gameId].lastPlayed === yesterday) {
                            userData.stats[gameId].streak++;
                        } else {
                            userData.stats[gameId].streak = 1;
                        }
                        userData.stats[gameId].lastPlayed = today;
                        userData.stats[gameId].totalPlays = (userData.stats[gameId].totalPlays || 0) + 1;
                        
                        // Also track in totalCompleted
                        if (!userData.stats.totalCompleted) userData.stats.totalCompleted = 0;
                        userData.stats.totalCompleted++;
                    }
                    
                    saveData();
                    recordHistory();
                    
                    // Publish activity to friends
                    publishActivity(gameId, game.name);
                    
                    // Show result in modal
                    result.style.display = 'block';
                    result.style.borderLeft = '4px solid var(--accent-green)';
                    resultIcon.textContent = game.icon;
                    resultGame.textContent = game.name;
                    resultScore.textContent = extracted.score + (extracted.success ? ' âœ“' : '');
                    
                    // Update UI
                    renderFeaturedGames();
                    renderMyGames();
                    updateStats();
                    renderCalendar();
                    updateDailyGoal();
                    renderInsights();
                    renderLeaderboard();
                    checkAndUnlockAchievements();
                    unlockTimeAchievement();
                    
                    showToast(`âœ“ ${game.name} logged!`);
                    input.value = '';
                    
                    // Close modal after delay
                    setTimeout(() => {
                        closeQuickLogModal();
                    }, 1500);
                    
                    matched = true;
                    break;
                }
            }
            
            if (!matched) {
                result.style.display = 'block';
                result.style.borderLeft = '4px solid var(--accent-red)';
                result.classList.remove('success');
                result.classList.add('error');
                resultIcon.textContent = 'â“';
                resultGame.textContent = 'Unknown Game';
                resultScore.textContent = 'Could not parse results. Try another format.';
            }
        }

        // ============ STATS ============
        function updateStats() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            // Count played today
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            document.getElementById('today-count').textContent = playedToday;
            document.getElementById('best-streak').textContent = bestStreak;
            document.getElementById('total-games').textContent = totalGames;
            
            // Also update share preview
            updateSharePreview();
        }

        // ============ UTILITIES ============
        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getYesterdayString() {
            const now = new Date();
            now.setDate(now.getDate() - 1);
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function isToday(dateStr) {
            return dateStr === getTodayString();
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('ðŸ“‹ RSS URL copied!');
            }).catch(() => {
                showToast('Failed to copy');
            });
        }

        // ============ CHAT/DISCUSSION ============
        function renderChat() {
            const container = document.getElementById('chat-messages');
            const messages = userData.chatMessages || [];
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="chat-empty">
                        <p>ðŸ’¬ No messages yet!</p>
                        <p style="font-size: 0.8rem;">Share your daily results, tips, or thoughts.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map((msg, index) => `
                <div class="chat-message">
                    <div class="chat-message-header">
                        <span class="chat-message-time">${formatChatTime(msg.timestamp)}</span>
                        <button class="chat-message-delete" onclick="deleteChatMessage(${index})">ðŸ—‘ï¸</button>
                    </div>
                    <div class="chat-message-text">${escapeHtml(msg.text)}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function postChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (!userData.chatMessages) userData.chatMessages = [];
            
            userData.chatMessages.push({
                text: text,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 messages
            if (userData.chatMessages.length > 50) {
                userData.chatMessages = userData.chatMessages.slice(-50);
            }
            
            saveData();
            input.value = '';
            renderChat();
        }

        function deleteChatMessage(index) {
            if (!confirm('Delete this message?')) return;
            userData.chatMessages.splice(index, 1);
            saveData();
            renderChat();
        }

        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Enter key in chat
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        postChatMessage();
                    }
                });
            }
        });

        // ============ SHARE SHELF ============
        function updateSharePreview() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            // Update share preview stats
            document.getElementById('share-played').textContent = playedToday;
            document.getElementById('share-streak').textContent = bestStreak;
            document.getElementById('share-total').textContent = totalGames;
            document.getElementById('share-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            
            // Show games in share preview
            const allGames = [...FEATURED_GAMES, ...userData.games].slice(0, 8);
            document.getElementById('share-games').innerHTML = allGames.map(game => {
                const stats = userData.stats[game.id] || { streak: 0 };
                const playedToday = isToday(stats.lastPlayed);
                return `
                    <div class="share-game-item" style="${playedToday ? 'border: 2px solid var(--accent-green);' : ''}">
                        <span class="icon">${game.icon}</span>
                        <div class="name">${game.name}</div>
                        ${stats.streak > 0 ? `<div class="streak">ðŸ”¥${stats.streak}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function shareAsText() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            const allGames = [...FEATURED_GAMES, ...userData.games];
            
            let text = `ðŸŽ® My Game Shelf\n`;
            text += `${new Date().toLocaleDateString()}\n\n`;
            text += `ðŸ“Š Today: ${playedToday}/${totalGames} | ðŸ”¥ Best Streak: ${bestStreak}\n\n`;
            
            const playedGames = allGames.filter(g => allStats[g.id] && isToday(allStats[g.id].lastPlayed));
            if (playedGames.length > 0) {
                text += `âœ… Played: ${playedGames.map(g => g.icon).join(' ')}\n`;
            }
            
            text += `\nðŸŽ¯ gameshelf.app`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('ðŸ“‹ Copied to clipboard!');
                // Unlock social achievement
                if (!userData.achievements['social']) {
                    userData.achievements['social'] = getTodayString();
                    saveData();
                    checkAndUnlockAchievements();
                }
            });
        }

        function shareNative() {
            const today = getTodayString();
            const allStats = { ...userData.stats };
            
            let playedToday = 0;
            let bestStreak = 0;
            
            Object.values(allStats).forEach(stat => {
                if (stat.lastPlayed === today) playedToday++;
                if (stat.streak > bestStreak) bestStreak = stat.streak;
            });
            
            const totalGames = FEATURED_GAMES.length + userData.games.length;
            
            const shareData = {
                title: 'My Game Shelf',
                text: `ðŸŽ® Game Shelf - ${playedToday}/${totalGames} played today! Best streak: ${bestStreak}ðŸ”¥`,
                url: 'https://gameshelf.app'
            };
            
            if (navigator.share) {
                navigator.share(shareData).then(() => {
                    // Unlock social achievement
                    if (!userData.achievements['social']) {
                        userData.achievements['social'] = getTodayString();
                        saveData();
                        checkAndUnlockAchievements();
                    }
                }).catch(() => {});
            } else {
                shareAsText();
            }
        }

        async function shareAsImage() {
            const preview = document.getElementById('share-preview');
            
            try {
                // Use html2canvas if available, otherwise fallback
                if (typeof html2canvas !== 'undefined') {
                    const canvas = await html2canvas(preview, {
                        backgroundColor: '#1a1a2e',
                        scale: 2
                    });
                    
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'gameshelf-' + getTodayString() + '.png';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('ðŸ“· Image saved!');
                    });
                } else {
                    // Fallback: copy text instead
                    showToast('ðŸ“‹ Copying text instead...');
                    shareAsText();
                }
            } catch (err) {
                shareAsText();
            }
        }

        // ============ SERVICE WORKER (PWA) ============
        if ('serviceWorker' in navigator) {
            // Use relative path for GitHub Pages compatibility
            const swPath = new URL('sw.js', window.location.href).href;
            navigator.serviceWorker.register(swPath)
                .then((registration) => {
                    console.log('ðŸŽ® Game Shelf PWA ready');
                })
                .catch((error) => {
                    console.log('Service worker registration failed:', error);
                });
        }

        // ============ START ============
        init();

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
